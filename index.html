<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fragrance Sommelier">
    <title>Fragrance Sommelier v83</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Base Reset & Fonts */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* Utility: Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Glassmorphism Panels */
        .glass-panel { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); 
        }
        
        /* Form Elements */
        select { 
            -webkit-appearance: none; 
            appearance: none; 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* Animation Utilities */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen w-screen overflow-hidden flex flex-col selection:bg-emerald-500 selection:text-white">

    <header class="flex-none p-4 pt-14 bg-slate-900 border-b border-slate-800 flex justify-between items-center z-20 shadow-lg">
        <div>
            <h1 class="text-xl font-bold tracking-tight text-white flex items-center gap-2">
                <i data-lucide="droplets" class="w-5 h-5 text-emerald-400"></i>
                Fragrance Sommelier
            </h1>
            <p class="text-xs text-slate-400 mt-0.5">System v83 • Deep Rotation Logic</p>
        </div>
        <div class="flex items-center gap-2">
             <button onclick="resetData()" class="text-[10px] text-slate-600 uppercase tracking-widest hover:text-red-400">Reset</button>
            <div id="status-indicator" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
        </div>
    </header>

    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar relative p-4 pb-32">
        </main>

    <nav class="flex-none fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 pb-8 pt-3 z-30 shadow-2xl">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button onclick="router('select')" id="nav-select" class="nav-btn flex flex-col items-center p-2 w-20 text-emerald-400 transition-all duration-200">
                <i data-lucide="search" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] uppercase tracking-wider font-medium">Select</span>
            </button>
            <button onclick="router('collect')" id="nav-collect" class="nav-btn flex flex-col items-center p-2 w-20 text-slate-500 hover:text-emerald-400 transition-all duration-200">
                <i data-lucide="library" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] uppercase tracking-wider font-medium">Collect</span>
            </button>
            <button onclick="router('history')" id="nav-history" class="nav-btn flex flex-col items-center p-2 w-20 text-slate-500 hover:text-emerald-400 transition-all duration-200">
                <i data-lucide="history" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] uppercase tracking-wider font-medium">History</span>
            </button>
        </div>
    </nav>

    <script>
        // ============================================================================
        // 1. DATA DICTIONARY (Sources 49, 52, 55, 44)
        // ============================================================================
        
        // Source 49: Fragrances (Bottles)
        const BOTTLES_DATA = [
            { id: "ambery_saffron", name: "Ambery Saffron", brand: "Dossier", ratings: { Date: 5, Intimate: 4, Office: 2, Casual: 3, Gym: 1 }, season: ["Winter", "Fall"], tier: "A" },
            { id: "lost_cherry", name: "Lost Cherry", brand: "Tom Ford", ratings: { Date: 5, Intimate: 5, Office: 1, Casual: 3, Gym: 0 }, season: ["Winter", "Fall"], tier: "S" },
            { id: "creed_aventus", name: "Aventus", brand: "Creed", ratings: { Office: 5, Casual: 5, Date: 4, Intimate: 3, Gym: 3 }, season: ["Spring", "Summer"], tier: "S" },
            { id: "victory_man", name: "Victory Man", brand: "XXIV", ratings: { Gym: 5, Office: 4, Casual: 3, Date: 2, Intimate: 1 }, season: ["Summer", "Spring"], tier: "B" },
            { id: "1_million", name: "1 Million", brand: "Paco Rabanne", ratings: { Date: 4, Casual: 2, Intimate: 3, Office: 1, Gym: 0 }, season: ["Winter", "Fall"], tier: "B" },
            { id: "blomb_27", name: "No. 27", brand: "BLOMB", ratings: { Casual: 5, Office: 3, Date: 3, Intimate: 2, Gym: 2 }, season: ["Fall", "Spring"], tier: "A" },
            { id: "phantom_noir", name: "Phantom Noir", brand: "Montagne", ratings: { Date: 5, Intimate: 5, Casual: 3, Office: 2, Gym: 1 }, season: ["Winter", "Fall"], tier: "A" },
            { id: "brooklyn_jazz", name: "Brooklyn Jazz", brand: "Montagne", ratings: { Date: 5, Intimate: 4, Casual: 4, Office: 2, Gym: 0 }, season: ["Winter", "Fall"], tier: "A" },
            { id: "maison_du_soir", name: "Maison du Soir", brand: "Montagne", ratings: { Intimate: 5, Casual: 5, Date: 4, Office: 2, Gym: 0 }, season: ["Winter", "Fall"], tier: "S" },
            { id: "cubicle_men", name: "Cubicle for Men", brand: "Montagne", ratings: { Office: 5, Casual: 4, Gym: 3, Date: 2, Intimate: 1 }, season: ["Summer", "Spring"], tier: "A" },
            { id: "gentle_silver", name: "Gentle Silver", brand: "Montagne", ratings: { Office: 5, Gym: 4, Casual: 3, Date: 2, Intimate: 1 }, season: ["Summer", "Spring"], tier: "A" },
            { id: "vanille_absolute", name: "Vanille Absolute", brand: "Montagne", ratings: { Date: 5, Intimate: 4, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter", "Fall"], tier: "B" },
            { id: "eau_noir", name: "Eau Noir", brand: "Montagne", ratings: { Date: 5, Casual: 5, Intimate: 4, Office: 2, Gym: 0 }, season: ["Fall", "Winter"], tier: "S" },
            { id: "prada_paradigme", name: "Paradigme", brand: "Prada", ratings: { Office: 5, Casual: 5, Date: 3, Intimate: 2, Gym: 2 }, season: ["Spring", "Summer"], tier: "A" },
            { id: "sainte_fumee", name: "Sainte Fumée", brand: "Fleurit", ratings: { Intimate: 5, Date: 5, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter", "Fall"], tier: "S" },
            { id: "terre_hermes", name: "Terre d'Hermès Eau Intense", brand: "Hermès", ratings: { Office: 5, Casual: 4, Date: 3, Intimate: 2, Gym: 1 }, season: ["Spring", "Fall"], tier: "A" }
        ];

        // Source 52: Decants
        const DECANTS_DATA = [
            { id: "custom_1765648274151", name: "Labdanum 18", brand: "Le Labo", type: "decant", ratings: { Intimate: 5, Date: 3, Office: 2, Casual: 3, Gym: 0 }, season: ["Winter", "Fall"], tags: "powdery, animalic, musk" },
            { id: "custom_1765726222017", name: "Fil d’Or No1", brand: "Laurent Mazzone", type: "decant", ratings: { Date: 5, Intimate: 4, Office: 1, Casual: 2, Gym: 0 }, season: ["Winter", "Fall"], tags: "boozy, tobacco, luxurious" },
            { id: "decant_black_orchid", name: "Black Orchid", brand: "Tom Ford", type: "decant", ratings: { Date: 4, Intimate: 4, Office: 0, Casual: 3, Gym: 0 }, season: ["Winter"], tags: "dark, floral, chocolate" }
        ];

        // Source 55: Combos (with fixed metadata per Source 61)
        const COMBOS_DATA = [
            { id: "combo_exec_suite", name: "The Executive Suite", brand: "Combo", ratings: { Date: 5, Office: 3, Intimate: 3, Casual: 4, Gym: 1 }, season: ["Fall", "Winter"], protocol: "4x Base, 2x Top" },
            { id: "combo_cherry_lounge", name: "Cherry Lounge", brand: "Combo", ratings: { Intimate: 5, Date: 5, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Jazz, 3x Cherry" },
            { id: "combo_gin_juice", name: "Gin & Juice", brand: "Combo", ratings: { Casual: 5, Gym: 4, Office: 3, Date: 2, Intimate: 1 }, season: ["Summer"], protocol: "4x Silver, 2x Aventus" },
            { id: "combo_smoked_vanilla", name: "Smoked Vanilla", brand: "Combo", ratings: { Intimate: 5, Date: 4, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Maison, 2x Vanille" },
            { id: "combo_island_noir", name: "Island Noir", brand: "Combo", ratings: { Date: 4, Casual: 5, Intimate: 3, Office: 2, Gym: 1 }, season: ["Summer"], protocol: "3x BLOMB, 3x Aventus" },
            { id: "combo_spiced_cherry", name: "Spiced Cherry", brand: "Combo", ratings: { Date: 5, Intimate: 5, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Vanille, 3x Cherry" },
            { id: "combo_clean_cut", name: "The Clean Cut", brand: "Combo", ratings: { Office: 5, Gym: 5, Casual: 3, Date: 2, Intimate: 1 }, season: ["Summer"], protocol: "3x Cubicle, 3x Silver" },
            { id: "combo_midnight_tea", name: "Midnight Tea", brand: "Combo", ratings: { Date: 5, Intimate: 4, Casual: 3, Office: 1, Gym: 0 }, season: ["Fall", "Winter"], protocol: "3x Jazz, 2x Eau Noir" },
            { id: "combo_smoked_jazz", name: "Smoked Jazz", brand: "Combo", ratings: { Intimate: 5, Date: 5, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Jazz, 2x Fumée" },
            { id: "combo_winter_hearth", name: "Winter Hearth", brand: "Combo", ratings: { Intimate: 5, Casual: 5, Date: 4, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Maison, 2x Fumée" },
            { id: "combo_holy_clean", name: "Holy Clean", brand: "Combo", ratings: { Casual: 5, Office: 3, Gym: 2, Date: 2, Intimate: 2 }, season: ["Fall", "Spring"], protocol: "4x Silver, 2x Fumée" },
            { id: "combo_sacred_vanilla", name: "Sacred Vanilla", brand: "Combo", ratings: { Intimate: 5, Date: 5, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Vanille, 2x Fumée" },
            { id: "combo_paradigm_shift", name: "Paradigm Shift", brand: "Combo", ratings: { Office: 5, Casual: 4, Gym: 3, Date: 2, Intimate: 1 }, season: ["Spring", "Summer"], protocol: "4x Cubicle, 4x Paradigme" },
            { id: "combo_holy_saffron", name: "Holy Saffron", brand: "Combo", ratings: { Date: 5, Intimate: 5, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Fumée, 3x Saffron" },
            { id: "combo_vanilla_smoke", name: "Vanilla Smoke", brand: "Combo", ratings: { Intimate: 5, Casual: 5, Date: 4, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Maison, 3x Vanille" },
            { id: "combo_holy_gin", name: "Holy Gin", brand: "Combo", ratings: { Casual: 5, Date: 3, Office: 2, Intimate: 2, Gym: 1 }, season: ["Fall", "Spring"], protocol: "4x Silver, 2x Fumée" },
            { id: "combo_vanilla_latte", name: "Vanilla Latte", brand: "Combo", ratings: { Date: 5, Intimate: 5, Casual: 4, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Phantom, 2x Vanille" },
            { id: "combo_london_fog", name: "London Fog", brand: "Combo", ratings: { Casual: 5, Office: 4, Date: 3, Intimate: 2, Gym: 1 }, season: ["Fall", "Winter"], protocol: "3x Eau Noir, 2x Vanille" },
            { id: "combo_office_power", name: "Office Power", brand: "Combo", ratings: { Office: 5, Gym: 4, Casual: 3, Date: 1, Intimate: 0 }, season: ["Summer"], protocol: "3x Victory, 3x Cubicle" },
            { id: "combo_tropical_hearth", name: "Tropical Hearth", brand: "Combo", ratings: { Date: 4, Casual: 5, Office: 2, Intimate: 3, Gym: 0 }, season: ["Fall", "Winter"], protocol: "3x Maison, 3x Aventus" },
            { id: "combo_the_ceo", name: "The CEO", brand: "Combo", ratings: { Office: 5, Casual: 3, Date: 2, Intimate: 1, Gym: 1 }, season: ["Spring", "Fall"], protocol: "3x Cubicle, 3x Hermes" },
            { id: "combo_gin_earth", name: "Gin & Earth", brand: "Combo", ratings: { Casual: 5, Office: 3, Gym: 2, Date: 2, Intimate: 1 }, season: ["Spring", "Summer"], protocol: "4x Silver, 2x Hermes" },
            { id: "combo_earth_king", name: "The Earth King", brand: "Combo", ratings: { Casual: 5, Office: 5, Date: 3, Intimate: 2, Gym: 1 }, season: ["Spring", "Fall"], protocol: "3x Hermes, 3x Aventus" },
            { id: "combo_midnight_cacao", name: "Midnight Cacao", brand: "Combo", ratings: { Date: 5, Intimate: 5, Casual: 3, Office: 1, Gym: 0 }, season: ["Winter"], protocol: "3x Phantom, 2x Fumée" },
            { id: "combo_iron_man", name: "Iron Man", brand: "Combo", ratings: { Gym: 5, Office: 4, Casual: 3, Date: 1, Intimate: 0 }, season: ["Summer", "Spring"], protocol: "4x Victory, 4x Paradigme" },
            { id: "combo_dark_architect", name: "The Dark Architect", brand: "Combo", ratings: { Date: 5, Intimate: 4, Casual: 3, Office: 2, Gym: 0 }, season: ["Winter", "Fall"], protocol: "3x Hermes, 2x Black Orchid" }
        ];

        // Source 44: Preloaded History (The 15 specific entries)
        const PRELOADED_HISTORY = [
            { date: "2025-11-29", time: "13:35", id: "cubicle_men", name: "Cubicle for Men", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-11-30", time: "13:45", id: "gentle_silver", name: "Gentle Silver", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-01", time: "12:39", id: "combo_clean_cut", name: "The Clean Cut", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-03", time: "20:21", id: "eau_noir", name: "Eau Noir", season: "Winter", weather: "Sunny", situation: "Casual" },
            { date: "2025-12-04", time: "12:48", id: "eau_noir", name: "Eau Noir", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-05", time: "12:44", id: "eau_noir", name: "Eau Noir", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-06", time: "13:29", id: "combo_gin_juice", name: "Gin & Juice", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-07", time: "13:30", id: "blomb_27", name: "No. 27", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-08", time: "12:41", id: "gentle_silver", name: "Gentle Silver", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-10", time: "16:55", id: "gentle_silver", name: "Gentle Silver", season: "Winter", weather: "Sunny", situation: "Casual" },
            { date: "2025-12-11", time: "12:40", id: "prada_paradigme", name: "Paradigme", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-12", time: "12:43", id: "eau_noir", name: "Eau Noir", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-13", time: "13:15", id: "custom_1765648274151", name: "Labdanum 18", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-14", time: "13:20", id: "custom_1765726222017", name: "Fil d’Or No1", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-15", time: "14:22", id: "creed_aventus", name: "Aventus", season: "Winter", weather: "Sunny", situation: "Office" }
        ];

        // ============================================================================
        // 2. APP STATE MANAGEMENT
        // ============================================================================
        
        const STORAGE_KEY = "scentApp_db_v83_fully_restored";
        
        let appData = {
            bottles: [],
            decants: [],
            combos: [],
            history: []
        };

        // Initialize App
        function initApp() {
            // Load from LocalStorage or Fallback to Source Data
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                appData = JSON.parse(stored);
                // V83 Fix: Ensure hardcoded data is merged if missing (Source 59)
                if(!appData.bottles || appData.bottles.length === 0) appData.bottles = BOTTLES_DATA;
                if(!appData.combos || appData.combos.length === 0) appData.combos = COMBOS_DATA;
                if(!appData.decants) appData.decants = DECANTS_DATA;
            } else {
                appData.bottles = BOTTLES_DATA;
                appData.decants = DECANTS_DATA;
                appData.combos = COMBOS_DATA;
                appData.history = PRELOADED_HISTORY;
                saveData();
            }

            // Start Routing
            router('select');
            lucide.createIcons();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        function resetData() {
            if(confirm("Reset all data to v83 factory defaults?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // ============================================================================
        // 3. CORE LOGIC: DEEP ROTATION ALGORITHM v82 (Source 28)
        // ============================================================================

        function runAlgorithm(situation, weather, season) {
            // Combine all inventory
            const inventory = [...appData.bottles, ...appData.decants, ...appData.combos];
            
            // Calculate Scores
            const scoredItems = inventory.map(item => {
                let score = 0;
                
                // 1. Situation Match (x4 Multiplier) - Source 31
                const sitRating = item.ratings[situation] || 0;
                score += (sitRating * 4);

                // 2. Weather/Season Match (x2 Multiplier) - Source 32
                // Note: Data has "season" array. Weather isn't explicitly rated in data, 
                // but implied via season affinity in v82 logic context. 
                // If item season matches current season selection:
                const isSeasonMatch = item.season.includes(season);
                if (isSeasonMatch) score += (3 * 2); // Base +3 for season match, x2 weight
                
                // 3. Tier Bonus - Source 33
                if (item.tier === 'S') score += 20;
                if (item.tier === 'A') score += 12;
                if (item.tier === 'B') score += 5;

                // 4. Freshness/Staleness - Source 34
                // Count wears in history
                const wearCount = appData.history.filter(log => log.id === item.id).length;
                if (wearCount === 0) {
                    score += 5; // Unworn bonus
                } else {
                    score -= (wearCount * 2); // Wear penalty
                }

                // 5. Jitter - Source 35
                score += (Math.random() * 4);

                return { ...item, score: score };
            });

            // Sort by Score Descending
            scoredItems.sort((a, b) => b.score - a.score);

            return {
                top3: scoredItems.slice(0, 3),
                rotation: scoredItems.slice(3, 10)
            };
        }

        function logWear(item, situation, weather, season) {
            const entry = {
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                id: item.id,
                name: item.name,
                situation: situation,
                weather: weather,
                season: season
            };
            appData.history.unshift(entry); // Add to top
            saveData();
            alert(`Logged: ${item.name}`);
            router('history');
        }

        // ============================================================================
        // 4. ROUTER & VIEW RENDERERS
        // ============================================================================

        function router(viewName) {
            // Update Footer UI
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-emerald-400');
                btn.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`nav-${viewName}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-slate-500');
                activeBtn.classList.add('text-emerald-400');
            }

            const container = document.getElementById('app-container');
            container.innerHTML = ''; // Clear current view

            // Render View
            if (viewName === 'select') renderSelectView(container);
            if (viewName === 'collect') renderCollectView(container);
            if (viewName === 'history') renderHistoryView(container);
            
            // Re-init Icons
            lucide.createIcons();
        }

        // --- VIEW: SELECT ---
        function renderSelectView(container) {
            const html = `
                <div class="space-y-6 fade-in max-w-md mx-auto">
                    <div class="glass-panel rounded-2xl p-5 space-y-4 shadow-lg">
                        <h2 class="text-sm font-semibold text-emerald-400 uppercase tracking-widest mb-2">Current Context</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-slate-400 block mb-1">Situation</label>
                                <select id="ctx-situation" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-emerald-500 outline-none">
                                    <option value="Office">Office</option>
                                    <option value="Date">Date Night</option>
                                    <option value="Casual">Casual</option>
                                    <option value="Intimate">Intimate</option>
                                    <option value="Gym">Gym</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 block mb-1">Season</label>
                                <select id="ctx-season" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-emerald-500 outline-none">
                                    <option value="Winter">Winter</option>
                                    <option value="Spring">Spring</option>
                                    <option value="Summer">Summer</option>
                                    <option value="Fall">Fall</option>
                                </select>
                            </div>
                        </div>
                        <div>
                             <label class="text-xs text-slate-400 block mb-1">Weather</label>
                             <select id="ctx-weather" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-emerald-500 outline-none">
                                <option value="Sunny">Sunny / Clear</option>
                                <option value="Rainy">Rainy / Overcast</option>
                                <option value="Snow">Snow / Cold</option>
                             </select>
                        </div>
                        <button onclick="handleFindScent()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-900/50 transition-all transform active:scale-95 flex justify-center items-center gap-2">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            Find My Scent
                        </button>
                    </div>

                    <div id="results-area" class="space-y-4 hidden"></div>
                </div>
            `;
            container.innerHTML = html;
        }

        function handleFindScent() {
            const situation = document.getElementById('ctx-situation').value;
            const season = document.getElementById('ctx-season').value;
            const weather = document.getElementById('ctx-weather').value;

            const results = runAlgorithm(situation, weather, season);
            const area = document.getElementById('results-area');
            
            let html = `<h3 class="text-xs text-slate-500 uppercase tracking-widest pl-1">Top Recommendations</h3>`;
            
            // Top 3 Cards
            results.top3.forEach((item, index) => {
                const labels = ["Signature Choice", "Excellent Alternative", "Wildcard"];
                const colors = ["border-emerald-500/50", "border-blue-500/30", "border-purple-500/30"];
                const bgs = ["bg-emerald-900/10", "bg-blue-900/10", "bg-purple-900/10"];

                html += `
                <div class="glass-panel rounded-xl p-4 border ${colors[index]} ${bgs[index]} relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-slate-800 px-2 py-1 rounded-bl-lg text-[10px] text-slate-400">${labels[index]}</div>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-lg text-white leading-tight">${item.name}</h4>
                            <p class="text-xs text-slate-400">${item.brand}</p>
                        </div>
                        <div class="text-xl font-bold text-slate-700 opacity-20">#${index + 1}</div>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-300">Score: ${Math.round(item.score)}</span>
                        ${item.tier ? `<span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-yellow-500 font-bold">Tier ${item.tier}</span>` : ''}
                    </div>
                    ${item.protocol ? `<div class="text-xs text-slate-300 bg-slate-900/50 p-2 rounded mb-3 border-l-2 border-emerald-500">Protocol: ${item.protocol}</div>` : ''}
                    
                    <button onclick='logWear(${JSON.stringify(item)}, "${situation}", "${weather}", "${season}")' class="w-full py-2 bg-slate-800 hover:bg-emerald-600 text-slate-200 hover:text-white rounded-lg text-xs font-semibold transition-colors flex justify-center items-center gap-2">
                        <i data-lucide="check-circle" class="w-3 h-3"></i> Wear This
                    </button>
                </div>`;
            });

            // Rotation List
            html += `<h3 class="text-xs text-slate-500 uppercase tracking-widest pl-1 mt-6">Rotation Options</h3>
                     <div class="glass-panel rounded-xl divide-y divide-slate-700/50">`;
            
            results.rotation.forEach(item => {
                html += `
                <div class="p-3 flex justify-between items-center hover:bg-slate-800/50 transition cursor-pointer" onclick='logWear(${JSON.stringify(item)}, "${situation}", "${weather}", "${season}")'>
                    <div>
                        <div class="text-sm font-medium text-slate-200">${item.name}</div>
                        <div class="text-[10px] text-slate-500">${item.brand}</div>
                    </div>
                    <div class="text-xs text-slate-600">${Math.round(item.score)}</div>
                </div>`;
            });
            html += `</div>`;

            area.innerHTML = html;
            area.classList.remove('hidden');
            area.classList.add('fade-in');
            lucide.createIcons();
        }

        // --- VIEW: COLLECT ---
        function renderCollectView(container) {
            let html = `
                <div class="space-y-6 max-w-md mx-auto fade-in">
                    <h2 class="text-xl font-bold">Collection</h2>
                    
                    <div>
                        <h3 class="text-xs text-emerald-400 uppercase tracking-widest mb-3 border-b border-slate-800 pb-1">Bottles (${appData.bottles.length})</h3>
                        <div class="grid grid-cols-1 gap-3">
                            ${appData.bottles.map(b => `
                                <div class="glass-panel p-3 rounded-lg flex justify-between items-center">
                                    <div>
                                        <div class="font-medium text-sm">${b.name}</div>
                                        <div class="text-xs text-slate-500">${b.brand}</div>
                                    </div>
                                    <div class="text-xs font-bold text-slate-600 bg-slate-900 px-2 py-1 rounded">${b.tier || '-'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xs text-emerald-400 uppercase tracking-widest mb-3 border-b border-slate-800 pb-1">Decants (${appData.decants.length})</h3>
                        <div class="grid grid-cols-1 gap-3">
                             ${appData.decants.map(d => `
                                <div class="glass-panel p-3 rounded-lg border-l-2 border-purple-500">
                                    <div class="font-medium text-sm">${d.name}</div>
                                    <div class="text-xs text-slate-500">${d.brand}</div>
                                    <div class="text-[10px] text-slate-400 mt-1 italic">${d.tags}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xs text-emerald-400 uppercase tracking-widest mb-3 border-b border-slate-800 pb-1">Combos (${appData.combos.length})</h3>
                        <div class="grid grid-cols-1 gap-3">
                             ${appData.combos.map(c => `
                                <div class="glass-panel p-3 rounded-lg border-l-2 border-blue-500">
                                    <div class="font-medium text-sm">${c.name}</div>
                                    <div class="text-xs text-slate-500">${c.protocol}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // --- VIEW: HISTORY ---
        function renderHistoryView(container) {
            if (appData.history.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500 mt-20">No history yet.</div>`;
                return;
            }

            let html = `
                <div class="max-w-md mx-auto fade-in">
                    <h2 class="text-xl font-bold mb-4">Wear Log</h2>
                    <div class="space-y-3">
            `;

            appData.history.forEach(log => {
                html += `
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-emerald-500">
                                <i data-lucide="spray-can" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm text-slate-200">${log.name}</div>
                                <div class="text-xs text-slate-500 flex gap-2">
                                    <span>${log.date}</span>
                                    <span>•</span>
                                    <span>${log.situation}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-slate-600 bg-slate-900/50 px-2 py-1 rounded">
                            ${log.season}
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
        }

        // ============================================================================
        // 5. BOOTSTRAP
        // ============================================================================
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
