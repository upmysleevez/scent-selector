<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ScentSelector">
    <meta name="theme-color" content="#1F2121">
    <title>Fragrance Sommelier v63</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", sans-serif;
            background-color: #1F2121;
            color: #F5F5F5;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        /* Safe Areas */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Utility */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(38, 40, 40, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .btn-active {
            background-color: #208D8D;
            color: white;
            border-color: #208D8D;
        }

        /* Tier Badge Styles */
        .tier-btn { font-family: monospace; transition: all 0.2s; }
        .tier-s { color: #fbbf24; border-color: #fbbf24; }
        .tier-a { color: #f87171; border-color: #f87171; }
        .tier-b { color: #60a5fa; border-color: #60a5fa; }
        .tier-c { color: #34d399; border-color: #34d399; }
        .tier-d { color: #9ca3af; border-color: #9ca3af; }
        .tier-active { background-color: #208D8D; color: white !important; border-color: #208D8D !important; font-weight: bold; transform: scale(1.1); }
        
        /* Custom Form Inputs */
        .input-glass {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        /* Combo Card Gradient */
        .combo-gradient {
            background: linear-gradient(135deg, rgba(38,40,40,0.9) 0%, rgba(32,141,141,0.2) 100%);
        }
        
        .tier-header {
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #9ca3af;
        }
        .tier-header::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: { 50: '#FCFCF9', 100: '#FFFFF5' },
                        charcoal: { 700: '#1F2121', 800: '#262828', 900: '#111' },
                        teal: { 300: '#32B8C6', 500: '#208D8D' },
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden text-gray-100 selection:bg-teal-500 selection:text-white">

    <!-- HEADER (Solid Background, Fixed) -->
    <header class="fixed top-0 w-full z-50 bg-charcoal-700 border-b border-white/5 shadow-lg px-6 py-4 safe-top">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-[10px] font-bold uppercase tracking-widest text-teal-300">ScentSelector</h1>
                <p class="text-xl font-semibold text-white tracking-tight" id="header-title">Daily Ritual</p>
            </div>
            <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                <i data-lucide="settings" class="w-6 h-6 text-gray-400"></i>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <div id="app-container" class="flex-1 flex flex-col relative h-full">
        <!-- pt-36 to fully clear the header and provide breathing room -->
        <main class="flex-1 overflow-y-auto overflow-x-hidden no-scrollbar relative p-4 pt-36 pb-48" id="main-content">
            
            <!-- VIEW 1: SELECTOR -->
            <div id="view-selector" class="space-y-6 max-w-md mx-auto fade-enter-active">
                <section>
                    <label class="text-xs font-medium text-gray-400 uppercase tracking-wider ml-1 mb-2 block">Situation</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setContext('situation', 'office')" class="ctx-btn glass-panel p-4 rounded-xl flex flex-col items-center gap-2 active:scale-95 transition-all" data-group="situation" data-val="office"><i data-lucide="briefcase" class="w-6 h-6 text-teal-300"></i><span class="text-sm font-medium">Office</span></button>
                        <button onclick="setContext('situation', 'gym')" class="ctx-btn glass-panel p-4 rounded-xl flex flex-col items-center gap-2 active:scale-95 transition-all" data-group="situation" data-val="gym"><i data-lucide="dumbbell" class="w-6 h-6 text-teal-300"></i><span class="text-sm font-medium">Gym</span></button>
                        <button onclick="setContext('situation', 'date_night')" class="ctx-btn glass-panel p-4 rounded-xl flex flex-col items-center gap-2 active:scale-95 transition-all" data-group="situation" data-val="date_night"><i data-lucide="wine" class="w-6 h-6 text-teal-300"></i><span class="text-sm font-medium">Date Night</span></button>
                        <button onclick="setContext('situation', 'casual')" class="ctx-btn glass-panel p-4 rounded-xl flex flex-col items-center gap-2 active:scale-95 transition-all" data-group="situation" data-val="casual"><i data-lucide="coffee" class="w-6 h-6 text-teal-300"></i><span class="text-sm font-medium">Casual</span></button>
                        <button onclick="setContext('situation', 'intimate')" class="ctx-btn glass-panel p-4 rounded-xl flex flex-col items-center gap-2 active:scale-95 transition-all col-span-2" data-group="situation" data-val="intimate"><i data-lucide="flame" class="w-6 h-6 text-teal-300"></i><span class="text-sm font-medium">Intimate</span></button>
                    </div>
                </section>

                <section>
                    <label class="text-xs font-medium text-gray-400 uppercase tracking-wider ml-1 mb-2 block">Weather</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setContext('weather', 'sunny')" class="ctx-btn glass-panel p-4 rounded-xl flex items-center justify-center gap-3 active:scale-95 transition-all" data-group="weather" data-val="sunny"><i data-lucide="sun" class="w-5 h-5 text-yellow-400"></i><span class="text-sm">Sunny</span></button>
                        <button onclick="setContext('weather', 'rainy')" class="ctx-btn glass-panel p-4 rounded-xl flex items-center justify-center gap-3 active:scale-95 transition-all" data-group="weather" data-val="rainy"><i data-lucide="cloud-rain" class="w-5 h-5 text-blue-400"></i><span class="text-sm">Rainy/Cold</span></button>
                    </div>
                </section>

                <section>
                    <label class="text-xs font-medium text-gray-400 uppercase tracking-wider ml-1 mb-2 block">Season</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setContext('season', 'winter')" class="ctx-btn glass-panel py-3 rounded-lg text-xs font-medium active:scale-95 transition-all" data-group="season" data-val="winter">Winter</button>
                        <button onclick="setContext('season', 'spring')" class="ctx-btn glass-panel py-3 rounded-lg text-xs font-medium active:scale-95 transition-all" data-group="season" data-val="spring">Spring</button>
                        <button onclick="setContext('season', 'summer')" class="ctx-btn glass-panel py-3 rounded-lg text-xs font-medium active:scale-95 transition-all" data-group="season" data-val="summer">Summer</button>
                        <button onclick="setContext('season', 'fall')" class="ctx-btn glass-panel py-3 rounded-lg text-xs font-medium active:scale-95 transition-all" data-group="season" data-val="fall">Fall</button>
                    </div>
                </section>

                <section id="suspense-section" class="hidden transition-all duration-300">
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between border-teal-500/30 border">
                        <div class="flex items-center gap-3"><div class="bg-teal-500/20 p-2 rounded-lg"><i data-lucide="ghost" class="w-5 h-5 text-teal-300"></i></div><div><h4 class="text-sm font-semibold text-teal-100">Suspense Mode</h4><p class="text-xs text-gray-400">Prioritize mystery & depth</p></div></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="suspense-toggle" class="sr-only peer" onchange="toggleSuspense()"><div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div></label>
                    </div>
                </section>

                <button onclick="generateRecommendations()" class="w-full bg-teal-500 hover:bg-teal-400 text-white font-bold py-4 rounded-xl shadow-lg shadow-teal-900/50 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-4"><i data-lucide="sparkles" class="w-5 h-5"></i><span>Find My Scent</span></button>
            </div>

            <!-- VIEW 2: RESULTS (TIERED) -->
            <div id="view-results" class="hidden space-y-4 max-w-md mx-auto">
                <button onclick="resetView()" class="mb-4 text-xs font-bold text-gray-400 hover:text-white flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Filter</button>
                <div id="results-container" class="space-y-2"></div>
            </div>

            <!-- VIEW 3: COLLECTION -->
            <div id="view-collection" class="hidden space-y-4 max-w-md mx-auto relative">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">My Collection</h2><button onclick="openSmartAdd()" class="bg-teal-500 hover:bg-teal-400 text-white text-xs font-bold px-3 py-2 rounded-full flex items-center gap-1 shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i> Add</button></div>
                <div class="flex p-1 bg-black/40 rounded-xl mb-4 border border-white/5">
                    <button onclick="setCollectionMode('bottles')" id="tab-bottles" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white/10 text-white">Bottles</button>
                    <button onclick="setCollectionMode('decants')" id="tab-decants" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-white">Decants</button>
                    <button onclick="setCollectionMode('combos')" id="tab-combos" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-white">Combos</button>
                </div>
                <div id="collection-list" class="space-y-3"></div>
            </div>

            <!-- VIEW 5: HISTORY -->
            <div id="view-history" class="hidden space-y-4 max-w-md mx-auto relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Wear Log</h2>
                    <!-- ADD ENTRY BUTTON -->
                    <button onclick="openAddLogModal()" class="bg-teal-500 p-2 rounded-full shadow-lg active:scale-90 transition-transform text-white"><i data-lucide="plus-square" class="w-5 h-5"></i></button>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>
        </main>
        
        <!-- FOOTER NAV - SOLID CHARCOAL -->
        <nav class="fixed bottom-0 w-full bg-charcoal-900 border-t border-white/5 flex justify-around items-center px-4 pt-4 z-50 safe-bottom pb-6 shadow-2xl">
            <button onclick="switchView('selector')" class="nav-btn flex flex-col items-center gap-1.5 text-teal-500 active:scale-95 transition-transform"><i data-lucide="search" class="w-8 h-8"></i><span class="text-xs font-bold tracking-wide">Select</span></button>
            <button onclick="switchView('collection')" class="nav-btn flex flex-col items-center gap-1.5 text-gray-500 hover:text-teal-300 active:scale-95 transition-transform"><i data-lucide="library" class="w-8 h-8"></i><span class="text-xs font-bold tracking-wide">Collect</span></button>
            <button onclick="switchView('history')" class="nav-btn flex flex-col items-center gap-1.5 text-gray-500 hover:text-teal-300 active:scale-95 transition-transform"><i data-lucide="history" class="w-8 h-8"></i><span class="text-xs font-bold tracking-wide">History</span></button>
        </nav>
    </div>

    <!-- MODALS -->
    
    <!-- History Edit Modal -->
    <div id="history-edit-modal" class="fixed inset-0 z-[65] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4"><div class="bg-charcoal-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-white/10"><h3 class="text-xl font-bold mb-4">Edit Log</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Date & Time</label><input type="datetime-local" id="hist-edit-date" class="w-full input-glass p-3 rounded-lg focus:outline-none focus:border-teal-500 text-sm"></div><div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Fragrance</label><select id="hist-edit-fragrance" class="w-full input-glass p-3 rounded-lg focus:outline-none focus:border-teal-500 text-sm appearance-none bg-none"></select></div><div class="flex gap-2 pt-2"><button onclick="closeHistoryEdit()" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm">Cancel</button><button onclick="saveHistoryEdit()" class="flex-1 bg-teal-500 hover:bg-teal-400 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Update Log</button></div><button onclick="deleteHistoryEntry()" class="w-full text-red-400 text-xs font-bold py-2 mt-2 hover:text-red-300">Delete Entry</button></div></div></div>

    <!-- Smart Add Modal -->
    <div id="smart-add-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4"><div class="bg-charcoal-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-white/10 transform transition-all h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Smart Add</h3><button onclick="closeSmartAdd()" class="p-2 bg-white/10 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button></div><div class="space-y-4 overflow-y-auto no-scrollbar flex-1"><div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Name & Brand</label><input type="text" id="sa-name" class="w-full input-glass p-3 rounded-lg mb-2" placeholder="Fragrance Name"><input type="text" id="sa-brand" class="w-full input-glass p-3 rounded-lg" placeholder="Brand / House"></div><div class="flex items-center gap-2 mt-2"><input type="checkbox" id="sa-is-decant" class="w-4 h-4 rounded border-gray-600 text-teal-500 focus:ring-teal-500"><label for="sa-is-decant" class="text-sm font-bold text-gray-300">Save as Decant/Sample</label></div><div class="bg-teal-900/20 p-4 rounded-xl border border-teal-500/20"><div class="flex items-center gap-2 mb-2"><i data-lucide="wand-2" class="w-4 h-4 text-teal-300"></i><label class="text-xs font-bold text-teal-300 uppercase tracking-wider">Paste Info Here</label></div><textarea id="sa-text" class="w-full bg-black/40 text-xs text-gray-300 p-3 rounded-lg border border-white/10 h-32 focus:outline-none focus:border-teal-500" placeholder="Paste notes/description..."></textarea><button onclick="analyzeText()" class="w-full mt-2 bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold py-2 rounded-lg">Analyze & Auto-Fill</button></div><div id="sa-results" class="hidden space-y-3"><div class="p-3 bg-white/5 rounded-lg"><h4 class="text-xs font-bold text-gray-400 mb-1">Detected Tags</h4><div id="sa-tags" class="flex flex-wrap gap-1"></div></div><div class="p-3 bg-white/5 rounded-lg"><h4 class="text-xs font-bold text-gray-400 mb-1">Suggested Combo</h4><p id="sa-combo" class="text-xs text-teal-200 italic">None detected</p></div></div></div><button onclick="saveSmartAdd()" class="w-full bg-teal-500 hover:bg-teal-400 text-white font-bold py-3 rounded-xl shadow-lg mt-4">Save to Collection</button></div></div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4"><div class="bg-charcoal-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-white/10"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">Data</h3><button onclick="toggleSettings()" class="p-2"><i data-lucide="x" class="w-4 h-4"></i></button></div><textarea id="backup-area" class="w-full bg-black/50 text-xs p-3 rounded-lg h-24 mb-2" readonly></textarea><div class="grid grid-cols-2 gap-2 mb-4"><button onclick="copyData()" class="bg-white/10 hover:bg-white/20 py-2 rounded-lg text-xs font-bold">Copy JSON</button><button onclick="copyStats()" class="bg-teal-500/20 hover:bg-teal-500/40 text-teal-300 py-2 rounded-lg text-xs font-bold">Copy Stats</button><button onclick="hardReset()" class="col-span-2 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg text-xs font-bold">Hard Reset</button></div><textarea id="restore-area" class="w-full bg-black/50 text-xs p-3 rounded-lg h-24 mb-2" placeholder="Paste JSON"></textarea><button onclick="restoreData()" class="w-full bg-teal-500 hover:bg-teal-400 py-2 rounded-lg text-xs font-bold">Restore (Smart Merge)</button></div></div>
    
    <!-- Notes Modal -->
    <div id="notes-modal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4"><div class="bg-charcoal-800 w-full max-w-sm rounded-2xl p-6"><h3 class="mb-2 font-bold">Notes</h3><textarea id="note-input" class="w-full input-glass p-3 h-32 mb-4 rounded"></textarea><div class="flex gap-2"><button onclick="closeNotesModal()" class="flex-1 p-3 bg-white/10 rounded">Cancel</button><button onclick="saveNote()" class="flex-1 p-3 bg-teal-500 rounded">Save</button></div></div></div>

    <!-- Add Log Modal -->
    <div id="add-log-modal" class="fixed inset-0 z-[65] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4"><div class="bg-charcoal-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-white/10"><h3 class="text-xl font-bold mb-4">Log Missed Wear</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Date & Time</label><input type="datetime-local" id="add-log-date" class="w-full input-glass p-3 rounded-lg focus:outline-none focus:border-teal-500 text-sm"></div><div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Fragrance / Combo</label><select id="add-log-fragrance" class="w-full input-glass p-3 rounded-lg focus:outline-none focus:border-teal-500 text-sm appearance-none bg-none"></select></div><div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Situation</label><select id="add-log-situation" class="w-full input-glass p-3 rounded-lg focus:outline-none focus:border-teal-500 text-sm appearance-none bg-none"><option value="office">Office</option><option value="gym">Gym</option><option value="date_night">Date Night</option><option value="casual">Casual</option><option value="intimate">Intimate</option></select></div><div class="flex gap-2 pt-2"><button onclick="closeAddLogModal()" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm">Cancel</button><button onclick="saveMissedLog()" class="flex-1 bg-teal-500 hover:bg-teal-400 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Save Log</button></div></div></div></div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-32 left-1/2 transform -translate-x-1/2 bg-teal-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 translate-y-[-150%] opacity-0 invisible transition-all duration-300 z-[70]"><i data-lucide="check-circle" class="w-5 h-5"></i><span class="font-bold text-sm">Saved</span></div>

    <script>
        const APP_ID = "scentApp_db_v63_clean_slate"; 
        const TIERS = ['S', 'A', 'B', 'C', 'D', 'E', 'F'];

        let state = {
            context: { season: 'fall', weather: 'sunny', situation: 'office', suspense: false },
            data: { fragrances: [], decants: [], combos: [], history: [] },
            ui: { collectionMode: 'bottles' }
        };

        const KEYWORDS = {
            winter: ["oud", "vanilla", "tobacco", "leather", "chocolate", "coffee", "rum", "cinnamon", "spice", "amber", "chestnut", "smoke", "incense"],
            summer: ["lime", "lemon", "bergamot", "citrus", "sea", "salt", "aquatic", "marine", "coconut", "mint", "ginger", "fresh"],
            fall: ["iris", "sandalwood", "fig", "tea", "cardamom", "cedar", "vetiver"],
            date: ["rose", "jasmine", "musk", "patchouli", "saffron", "sweet", "boozy", "gourmand"],
            office: ["soap", "clean", "white musk", "lavender", "neroli", "cotton"]
        };

        let tempSmartObj = null; 
        let currentNoteId = null; 
        let editingHistoryIndex = null; 
        let toastTimeout = null;

        const CUSTOM_DB = [
            { id: "dossier_ambery_saffron", name: "Ambery Saffron", brand: "Dossier", inspiration: "BR 540", tags: ["sweet", "saffron", "unisex", "date_night"], weatherAffinity: { winter_sunny: 2, winter_rainy: 1, summer_sunny: -2, summer_rainy: -1, spring: 1, fall: 2 }, situationRatings: { office: 2, gym: 0, casual: 4, date_night: 5, intimate: 4 }, sprayInstructions: "4-5 sprays (Shoulders, Neck, Back of Neck).", description: "A sweet, airy amber-saffron cloud.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "lost_cherry", name: "Lost Cherry", brand: "Tom Ford", inspiration: "Original", tags: ["gourmand", "cherry", "almond", "boozy", "suspense"], weatherAffinity: { winter_sunny: 1, winter_rainy: 2, summer_sunny: -3, summer_rainy: -2, spring: 0, fall: 2 }, situationRatings: { office: 1, gym: 0, casual: 3, date_night: 5, intimate: 5 }, sprayInstructions: "6-8 sprays (All over clothes + Hair).", description: "Decadent cherry-almond liqueur.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "creed_aventus", name: "Aventus", brand: "Creed", inspiration: "Original", tags: ["fresh", "smoky", "fruity", "king", "office"], weatherAffinity: { winter_sunny: 0, winter_rainy: -1, summer_sunny: 2, summer_rainy: 1, spring: 2, fall: 1 }, situationRatings: { office: 5, gym: 2, casual: 5, date_night: 4, intimate: 3 }, sprayInstructions: "6-7 sprays (3 on neck, 4 on shirt).", description: "Smoky pineapple and birch. The ultimate confidence booster.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "victory_man", name: "Victory Man", brand: "XXIV", inspiration: "Unknown/Fresh", tags: ["fresh", "citrus", "cedar", "gym"], weatherAffinity: { winter_sunny: -1, winter_rainy: -2, summer_sunny: 2, summer_rainy: 1, spring: 2, fall: 0 }, situationRatings: { office: 4, gym: 5, casual: 4, date_night: 1, intimate: 1 }, sprayInstructions: "8 sprays (Heavy on shirt/gym clothes).", description: "Bergamot and Cedarwood bomb. Clean, sharp, and energizing.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "paco_1_million", name: "1 Million", brand: "Paco Rabanne", inspiration: "Original", tags: ["sweet", "spicy", "loud", "club"], weatherAffinity: { winter_sunny: 2, winter_rainy: 1, summer_sunny: -3, summer_rainy: -2, spring: 0, fall: 1 }, situationRatings: { office: 0, gym: 0, casual: 2, date_night: 4, intimate: 2 }, sprayInstructions: "4-5 sprays (Chest and Neck).", description: "Sweet, spicy bubblegum. Designed for loud parties.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "blomb_27", name: "No. 27", brand: "BLOMB", inspiration: "Original", tags: ["woody", "tobacco", "coconut", "unique"], weatherAffinity: { winter_sunny: 1, winter_rainy: 1, summer_sunny: -1, summer_rainy: 0, spring: 1, fall: 2 }, situationRatings: { office: 3, gym: 0, casual: 5, date_night: 3, intimate: 3 }, sprayInstructions: "6 sprays (Shirt Front/Back).", description: "Unique woody-tobacco with a coconut twist.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "phantom_noir", name: "Phantom Noir", brand: "Montagne", inspiration: "Black Phantom?", tags: ["coffee", "boozy", "chocolate", "dark", "suspense"], weatherAffinity: { winter_sunny: 2, winter_rainy: 2, summer_sunny: -4, summer_rainy: -2, spring: -1, fall: 2 }, situationRatings: { office: 0, gym: 0, casual: 2, date_night: 5, intimate: 5 }, sprayInstructions: "5-6 sprays (Jacket/Scarf heavy).", description: "Coffee, booze, and sugar. Dark and mysterious.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "brooklyn_jazz", name: "Brooklyn Jazz", brand: "Montagne", inspiration: "Maison Margiela Jazz Club", tags: ["boozy", "tobacco", "rum", "smooth"], weatherAffinity: { winter_sunny: 2, winter_rainy: 2, summer_sunny: -2, summer_rainy: 0, spring: 0, fall: 2 }, situationRatings: { office: 2, gym: 0, casual: 4, date_night: 5, intimate: 4 }, sprayInstructions: "6-7 sprays (Collar, Chest, Wrists).", description: "Boozy rum and tobacco. Captures the vibe of a dim jazz bar.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "maison_du_soir", name: "Maison du Soir", brand: "Montagne", inspiration: "By the Fireplace", tags: ["smoke", "vanilla", "chestnut", "cozy"], weatherAffinity: { winter_sunny: 2, winter_rainy: 2, summer_sunny: -4, summer_rainy: -2, spring: -1, fall: 2 }, situationRatings: { office: 2, gym: 0, casual: 5, date_night: 3, intimate: 5 }, sprayInstructions: "5 sprays (Sweater/Chest).", description: "Chestnut and vanilla smoke. The ultimate 'Cozy' scent.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "cubicle_men", name: "Cubicle for Men", brand: "Montagne", inspiration: "Fragrance One Office", tags: ["ambroxan", "fresh", "safe", "power"], weatherAffinity: { winter_sunny: 0, winter_rainy: -1, summer_sunny: 1, summer_rainy: 0, spring: 2, fall: 1 }, situationRatings: { office: 5, gym: 3, casual: 4, date_night: 2, intimate: 1 }, sprayInstructions: "8-10 sprays (Full coverage on shirt).", description: "Clean, soapy, and projecting. Perfect Office scent.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "gentle_silver", name: "Gentle Silver", brand: "Montagne", inspiration: "Gentle Fluidity Silver", tags: ["gin", "juniper", "fresh", "crisp"], weatherAffinity: { winter_sunny: 1, winter_rainy: -1, summer_sunny: 2, summer_rainy: 1, spring: 2, fall: 1 }, situationRatings: { office: 5, gym: 4, casual: 4, date_night: 3, intimate: 2 }, sprayInstructions: "8-10 sprays (Saturate shirt front).", description: "Crisp juniper. Smells like a cold Gin & Tonic.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "vanille_absolute", name: "Vanille Absolute", brand: "Montagne", inspiration: "Nishane Ani?", tags: ["vanilla", "spicy", "ginger", "green"], weatherAffinity: { winter_sunny: 2, winter_rainy: 1, summer_sunny: -2, summer_rainy: -1, spring: 0, fall: 2 }, situationRatings: { office: 2, gym: 0, casual: 4, date_night: 5, intimate: 4 }, sprayInstructions: "5-6 sprays (Neck + Clothes).", description: "Spicy ginger and rich vanilla.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "eau_noir", name: "Eau Noir", brand: "Montagne", inspiration: "The Noir 29", tags: ["tea", "fig", "hay", "suspense", "dark"], weatherAffinity: { winter_sunny: 1, winter_rainy: 1, summer_sunny: -1, summer_rainy: 1, spring: 1, fall: 2 }, situationRatings: { office: 3, gym: 0, casual: 5, date_night: 5, intimate: 4 }, sprayInstructions: "6-7 sprays (Behind Ears + Collar).", description: "Black tea, fig, and tobacco. Mysterious and shifting.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "prada_paradigme", name: "Paradigme", brand: "Prada", inspiration: "Original", tags: ["fresh", "clean", "floral", "office"], weatherAffinity: { winter_sunny: 0, winter_rainy: -1, summer_sunny: 1, summer_rainy: 1, spring: 2, fall: 2 }, situationRatings: { office: 5, gym: 1, casual: 5, date_night: 3, intimate: 2 }, sprayInstructions: "8-10 sprays (Neck + Shirt).", description: "A modern paradigm of Prada's clean, soapy, and floral style.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' },
            { id: "fleurit_sainte_fumee", name: "Sainte Fumée", brand: "Fleurit Parfums", inspiration: "Original", tags: ["smoke", "incense", "dark", "intimate"], weatherAffinity: { winter_sunny: 2, winter_rainy: 2, summer_sunny: -4, summer_rainy: -2, spring: 0, fall: 2 }, situationRatings: { office: 0, gym: 0, casual: 2, date_night: 5, intimate: 5 }, sprayInstructions: "4-5 sprays (Chest/Neck).", description: "Holy Smoke. Deep resins and incense for intimate winter nights.", wearCount: 0, userNotes: "", userRating: 0, pairingOnly: false, paused: false, reviewStatus: 'approved' }
        ];

        const COMBOS_DB = [
            { id: "combo_executive", name: "The Executive Suite", parts: ["creed_aventus", "dossier_ambery_saffron"], tags: ["date_night", "power", "complex"], situationRatings: { office: 3, gym: 0, casual: 5, date_night: 5, intimate: 4 }, description: "Smoky birch meets airy saffron sweetness. A massive compliment magnet.", instructions: "Aventus (4x) on shirt chest. Saffron (3x) on neck skin.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_cherry_lounge", name: "Cherry Lounge", parts: ["lost_cherry", "brooklyn_jazz"], tags: ["boozy", "gourmand", "suspense"], situationRatings: { office: 0, gym: 0, casual: 3, date_night: 5, intimate: 5 }, description: "Boozy rum and tobacco darkens the cherry almond profile. Very sexy.", instructions: "Brooklyn Jazz (4x) on clothes. Lost Cherry (3x) on pulse points.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_gin_juice", name: "Gin & Juice", parts: ["gentle_silver", "creed_aventus"], tags: ["fresh", "fruity", "energy"], situationRatings: { office: 4, gym: 4, casual: 5, date_night: 3, intimate: 2 }, description: "Juniper berry and pineapple. An explosion of freshness.", instructions: "4 sprays each on opposite shirt shoulders.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_smoked_vanilla", name: "Smoked Vanilla", parts: ["maison_du_soir", "vanille_absolute"], tags: ["cozy", "winter", "gourmand"], situationRatings: { office: 1, gym: 0, casual: 5, date_night: 4, intimate: 5 }, description: "Chestnut smoke mixed with spicy ginger vanilla. Ultimate cozy mode.", instructions: "Maison (3x) on shirt/sweater. Vanille (3x) on wrists/neck.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_island_noir", name: "Island Noir", parts: ["creed_aventus", "blomb_27"], tags: ["summer", "night", "unique"], situationRatings: { office: 2, gym: 0, casual: 5, date_night: 4, intimate: 3 }, description: "Pineapple meets Coconut and Tobacco. A dark, smoky Piña Colada vibe.", instructions: "BLOMB (4x) on shirt. Aventus (3x) on neck.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_spiced_cherry", name: "Spiced Cherry", parts: ["lost_cherry", "vanille_absolute"], tags: ["gourmand", "winter", "date_night"], situationRatings: { office: 1, gym: 0, casual: 3, date_night: 5, intimate: 5 }, description: "Ginger and Green Vanilla cut the sweetness of the Cherry. Sophisticated gourmand.", instructions: "Vanille (3x) first, top with Lost Cherry (3x).", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_clean_cut", name: "The Clean Cut", parts: ["cubicle_men", "gentle_silver"], tags: ["office", "fresh", "clean"], situationRatings: { office: 5, gym: 5, casual: 3, date_night: 1, intimate: 1 }, description: "Ambroxan power meets Juniper freshness. The ultimate 'clean' scent profile.", instructions: "3 sprays of each on opposite shirt shoulders.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_midnight_tea", name: "Midnight Tea", parts: ["eau_noir", "brooklyn_jazz"], tags: ["dark", "boozy", "suspense"], situationRatings: { office: 1, gym: 0, casual: 4, date_night: 5, intimate: 4 }, description: "Black tea and Fig mixed with Rum and Tobacco. Dark, moody, and intellectual.", instructions: "Brooklyn Jazz (4x) on clothes. Eau Noir (3x) behind ears.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_smoked_jazz", name: "Smoked Jazz", parts: ["fleurit_sainte_fumee", "brooklyn_jazz"], tags: ["boozy", "incense", "dark"], situationRatings: { office: 0, gym: 0, casual: 2, date_night: 5, intimate: 5 }, description: "Boozy rum and tobacco meets holy incense. A speakeasy vibe.", instructions: "Jazz Club on neck (projection), Sainte Fumée on chest (base).", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_winter_hearth", name: "Winter Hearth", parts: ["fleurit_sainte_fumee", "maison_du_soir"], tags: ["cozy", "smoke", "winter"], situationRatings: { office: 0, gym: 0, casual: 4, date_night: 3, intimate: 5 }, description: "Chestnut fire and church incense. Maximum winter coziness.", instructions: "Maison on sweater, Sainte Fumée on skin.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_holy_clean", name: "Holy Clean", parts: ["fleurit_sainte_fumee", "gentle_silver"], tags: ["unique", "contrast", "casual"], situationRatings: { office: 3, gym: 0, casual: 5, date_night: 3, intimate: 2 }, description: "Clean gin meets dark incense. An interesting, artistic contrast.", instructions: "Gentle Silver on shirt (clean), Sainte Fumée on wrists.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_sacred_vanilla", name: "Sacred Vanilla", parts: ["fleurit_sainte_fumee", "vanille_absolute"], tags: ["gourmand", "sensual", "date_night"], situationRatings: { office: 1, gym: 0, casual: 3, date_night: 5, intimate: 5 }, description: "Vanilla sweetness balanced by dark resins. Sensual and mysterious.", instructions: "Vanille as base, Sainte Fumée to cut sweetness.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_paradigm_shift", name: "Paradigm Shift", parts: ["prada_paradigme", "cubicle_men"], tags: ["office", "clean", "professional"], situationRatings: { office: 5, gym: 1, casual: 3, date_night: 2, intimate: 1 }, description: "The ultimate clean professional. Soapy floral meets ambroxan power.", instructions: "Cubicle on shirt (power), Paradigme on skin (refinement).", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_holy_saffron", name: "Holy Saffron", parts: ["fleurit_sainte_fumee", "dossier_ambery_saffron"], tags: ["date_night", "unique", "sweet"], situationRatings: { office: 0, gym: 0, casual: 3, date_night: 5, intimate: 5 }, description: "Burnt sugar and airy saffron mixed with deep church incense.", instructions: "Sainte Fumée chest, Saffron neck.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_vanilla_smoke_2", name: "Vanilla Smoke", parts: ["maison_du_soir", "vanille_absolute"], tags: ["winter", "cozy", "sweet"], situationRatings: { office: 1, gym: 0, casual: 5, date_night: 3, intimate: 5 }, description: "Ultimate winter sweater combo. Vanilla, chestnut, and ginger.", instructions: "Layer both on sweater.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_holy_gin", name: "Holy Gin", parts: ["gentle_silver", "fleurit_sainte_fumee"], tags: ["unique", "fresh", "dark"], situationRatings: { office: 2, gym: 0, casual: 5, date_night: 4, intimate: 3 }, description: "Fresh Juniper vs Dark Incense. High contrast, very artistic.", instructions: "Sainte Fumée chest, Gentle Silver neck/wrists.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_vanilla_latte", name: "Vanilla Latte", parts: ["phantom_noir", "vanille_absolute"], tags: ["gourmand", "sweet", "winter"], situationRatings: { office: 0, gym: 0, casual: 4, date_night: 5, intimate: 5 }, description: "Coffee/Chocolate layered with Green Vanilla. Rich and delicious.", instructions: "Phantom chest, Vanille neck.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_london_fog", name: "London Fog", parts: ["eau_noir", "vanille_absolute"], tags: ["tea", "cozy", "relaxing"], situationRatings: { office: 3, gym: 0, casual: 5, date_night: 4, intimate: 5 }, description: "Black Tea and Fig softened by Vanilla. Like a warm drink.", instructions: "Eau Noir behind ears, Vanille on collar.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_office_power", name: "Office Power", parts: ["victory_man", "cubicle_men"], tags: ["office", "fresh", "strong"], situationRatings: { office: 5, gym: 4, casual: 3, date_night: 1, intimate: 1 }, description: "Citrus/Cedar + Ambroxan. Maximum clean projection.", instructions: "Cubicle chest, Victory Man neck.", wearCount: 0, userNotes: "", userRating: 0 },
            { id: "combo_tropical_hearth", name: "Tropical Hearth", parts: ["creed_aventus", "maison_du_soir"], tags: ["smoky", "fruity", "unique"], situationRatings: { office: 1, gym: 0, casual: 4, date_night: 4, intimate: 4 }, description: "Smoky Pineapple meets Chestnut Fire. Complex smoke layers.", instructions: "Maison chest, Aventus neck.", wearCount: 0, userNotes: "", userRating: 0 }
        ];

        // --- GLOBAL INITIALIZATION ---
        // Ensure everything is defined before running logic
        function loadData() {
            const raw = localStorage.getItem(APP_ID);
            if (raw) {
                try {
                    let savedData = JSON.parse(raw);
                    // Safe defaults
                    if(!savedData.decants) savedData.decants = [];
                    if(!savedData.history) savedData.history = [];
                    
                    // Merge Fragrances
                    state.data.fragrances = CUSTOM_DB.map(sysF => {
                        const savedF = (savedData.fragrances || []).find(f => f.id === sysF.id);
                        if (savedF) {
                            return { 
                                ...sysF, 
                                wearCount: savedF.wearCount || 0,
                                userNotes: savedF.userNotes || "",
                                userRating: savedF.userRating || 0,
                                pairingOnly: savedF.pairingOnly || false,
                                paused: savedF.paused || false,
                                reviewStatus: savedF.reviewStatus || 'approved'
                            };
                        }
                        return sysF;
                    });
                    
                    // Keep custom added
                    (savedData.fragrances || []).forEach(f => {
                         if (!CUSTOM_DB.find(cdb => cdb.id === f.id)) state.data.fragrances.push(f);
                    });

                    // Merge Combos
                    state.data.combos = COMBOS_DB.map(sysC => {
                        const savedC = (savedData.combos || []).find(c => c.id === sysC.id);
                        if (savedC) {
                            return { ...sysC, wearCount: savedC.wearCount || 0, userNotes: savedC.userNotes || "", userRating: savedC.userRating || 0 };
                        }
                        return sysC;
                    });
                    
                    state.data.decants = savedData.decants;
                    state.data.history = savedData.history.filter(h => h && h.id && h.date);

                    // AUTO-CALIBRATE WEAR COUNTS ON LOAD
                    state.data.fragrances.forEach(f => f.wearCount = 0);
                    state.data.combos.forEach(c => c.wearCount = 0);

                    state.data.history.forEach(log => {
                        if (log.type === 'single') {
                            const f = state.data.fragrances.find(x => x.id === log.id);
                            if(f) f.wearCount++;
                        } else if (log.type === 'combo') {
                            const c = state.data.combos.find(x => x.id === log.id);
                            if(c) {
                                c.wearCount++;
                                c.parts.forEach(pid => {
                                    const part = state.data.fragrances.find(p => p.id === pid);
                                    if(part) part.wearCount++;
                                });
                            }
                        }
                    });

                } catch(e) {
                    console.error("Data Corrupted", e);
                    setDefaultData();
                }
            } else {
                setDefaultData();
            }
            const backupArea = document.getElementById('backup-area');
            if(backupArea) backupArea.value = JSON.stringify(state.data);
        }

        function setDefaultData() {
            state.data = { 
                fragrances: JSON.parse(JSON.stringify(CUSTOM_DB)), 
                decants: [], 
                combos: JSON.parse(JSON.stringify(COMBOS_DB)), 
                history: []
            };
            saveData();
        }

        function saveData() {
            localStorage.setItem(APP_ID, JSON.stringify(state.data));
            const backupArea = document.getElementById('backup-area');
            if(backupArea) backupArea.value = JSON.stringify(state.data);
        }

        function hardReset() {
            if(confirm("Reset all data to defaults? This cannot be undone.")) {
                localStorage.removeItem(APP_ID);
                location.reload();
            }
        }

        function restoreData() {
            try {
                let rawInput = document.getElementById('restore-area').value.trim();
                if (rawInput.startsWith('"') && rawInput.endsWith('"')) {
                    rawInput = rawInput.substring(1, rawInput.length - 1).replace(/\\"/g, '"');
                }
                const backup = JSON.parse(rawInput);
                
                if(!backup.fragrances || !Array.isArray(backup.fragrances)) throw new Error("Invalid Format");
                
                localStorage.setItem(APP_ID, JSON.stringify(backup));
                alert("Data Restored!");
                location.reload();
            } catch (e) {
                alert('Invalid JSON Data.');
            }
        }

        // --- UI & LOGIC FUNCTIONS ---
        
        function initUI() {
            switchView('selector');
            updateContextUI();
        }

        function switchView(viewName) {
            ['view-selector', 'view-results', 'view-collection', 'view-history'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            const target = document.getElementById(viewName === 'selector' ? 'view-selector' : 'view-' + viewName);
            if(target) target.classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-teal-500'));
            const navMap = { 'selector': 0, 'results': 0, 'collection': 1, 'history': 2 };
            const idx = navMap[viewName];
            const navBtns = document.querySelectorAll('nav button');
            if(navBtns[idx]) navBtns[idx].classList.add('text-teal-500');

            if (viewName === 'collection') showCollection(); 
            if (viewName === 'history') renderHistory();
            
            document.getElementById('main-content').scrollTop = 0;
            if (window.lucide) lucide.createIcons();
        }

        function setContext(type, value) { 
            state.context[type] = value; 
            updateContextUI(); 
            const sus = document.getElementById('suspense-section');
            if (state.context.situation === 'date_night' || state.context.situation === 'intimate') sus.classList.remove('hidden');
            else { sus.classList.add('hidden'); state.context.suspense = false; document.getElementById('suspense-toggle').checked = false; }
        }

        function updateContextUI() {
             document.querySelectorAll('.ctx-btn').forEach(btn => {
                const group = btn.dataset.group; const val = btn.dataset.val;
                if (state.context[group] === val) { 
                    btn.classList.add('btn-active'); btn.classList.remove('glass-panel'); 
                    const icon = btn.querySelector('svg'); 
                    if(icon) { icon.classList.remove('text-teal-300', 'text-yellow-400', 'text-blue-400'); icon.classList.add('text-white'); }
                } else { 
                    btn.classList.remove('btn-active'); btn.classList.add('glass-panel'); 
                    const icon = btn.querySelector('svg'); 
                    if(icon) { icon.classList.remove('text-white'); 
                        if(group === 'situation') icon.classList.add('text-teal-300'); 
                        if(val === 'sunny') icon.classList.add('text-yellow-400'); 
                        if(val === 'rainy') icon.classList.add('text-blue-400'); 
                    }
                }
            });
        }

        function toggleSuspense() { state.context.suspense = document.getElementById('suspense-toggle').checked; }

        function calculateScore(item, isCombo) {
            const ctx = state.context; 
            let score = 0;
            
            const sitScore = item.situationRatings ? (item.situationRatings[ctx.situation] || 0) : 0; 
            if (sitScore < 2) return -100; 
            score += sitScore * 2;
            
            if (!isCombo && item.weatherAffinity) {
                let weatherKey = `${ctx.season}_${ctx.weather}`;
                if (item.weatherAffinity[weatherKey] === undefined) { 
                    if (ctx.season === 'fall') weatherKey = 'fall'; 
                }
                score += (item.weatherAffinity[weatherKey] || 0) * 1.5;
            }

            if (!isCombo) {
                if(item.pairingOnly || item.paused) return -999;
                
                if (item.userRating === 'S') score += 5.0;
                else if (item.userRating === 'A') score += 3.0;
                else if (item.userRating === 'B') score += 1.0;

                let limit = 5;
                if (item.userRating === 'S') limit = 12;
                else if (item.userRating === 'A') limit = 8;

                if (item.wearCount === 0) score += 3; 
                else if (item.wearCount > limit) score -= 2;
            } else {
                score += 1; 
            }

            if (ctx.suspense && item.tags && item.tags.includes('suspense')) score += 3;
            
            return score;
        }

        function generateRecommendations() {
            const container = document.getElementById('results-container'); container.innerHTML = '';
            
            const scoredSingles = state.data.fragrances.map(f => ({ ...f, score: calculateScore(f, false), type: 'single' }));
            const scoredCombos = state.data.combos.map(c => ({ ...c, score: calculateScore(c, true), type: 'combo' }));
            
            const scoredDecants = state.data.decants.map(d => {
                let score = 0;
                if (d.rating === null) score = 15; 
                else if (d.rating === 'like') score = 10;
                else score = -50;
                return { ...d, score, type: 'decant' };
            });

            const results = [...scoredSingles, ...scoredCombos, ...scoredDecants].filter(f => f.score > -20).sort((a, b) => b.score - a.score);

            if (results.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-400">No suitable fragrances found. Try changing the situation.</div>`;
            } else {
                results.slice(0, 3).forEach((item, idx) => {
                    if(idx===0) container.appendChild(createTierHeader("🏆 The Signature"));
                    if(idx===1) container.appendChild(createTierHeader("🥈 Alternative"));
                    
                    if(item.type === 'single') container.appendChild(createFragranceCard(item, idx===0));
                    else if(item.type === 'combo') container.appendChild(createComboCard(item, idx===0));
                    else if(item.type === 'decant') {
                        const div = document.createElement('div');
                        div.className = "glass-panel p-4 rounded-xl border border-dashed border-teal-500/50 mb-2";
                        div.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div><h3 class="font-bold text-white">${item.name}</h3><span class="text-[10px] bg-teal-500 px-2 rounded text-white">DECANT</span></div>
                            </div>
                            <button onclick="logDecantWear('${item.id}')" class="mt-2 w-full bg-white/10 py-2 rounded text-xs font-bold text-white hover:bg-white/20">Log Wear</button>`;
                        container.appendChild(div);
                    }
                });
            }
            switchView('results');
        }

        function createTierHeader(text) { const div = document.createElement('div'); div.className = 'tier-header'; div.innerText = text; return div; }

        function createFragranceCard(f, isTop) {
             const div = document.createElement('div');
             const bgClass = isTop ? 'bg-gradient-to-br from-charcoal-700 to-teal-900/20 border-teal-500/50' : 'glass-panel border-white/5';
             const wearColor = f.wearCount > 4 ? 'text-red-400' : (f.wearCount === 0 ? 'text-green-400' : 'text-gray-400');
             div.className = `${bgClass} p-5 rounded-2xl border relative transition-all mb-3`;
             div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="text-[10px] font-bold tracking-widest text-teal-400 uppercase">${f.brand}</span>
                        <h3 class="text-xl font-bold text-white leading-tight">${f.name}</h3>
                        <p class="text-xs text-teal-300 italic mt-0.5">${f.inspiration || ''}</p>
                    </div>
                    <button onclick="openNote('${f.id}')" class="text-gray-400 hover:text-white"><i data-lucide="sticky-note" class="w-4 h-4"></i></button>
                </div>
                <div class="bg-black/20 p-3 rounded-lg my-3 border border-white/5"><p class="text-sm text-gray-200 leading-relaxed">"${f.description}"</p></div>
                <div class="flex items-center gap-2 mb-4"><i data-lucide="spray-can" class="w-4 h-4 text-gray-400"></i><span class="text-xs text-gray-400 font-mono">${f.sprayInstructions}</span></div>
                <div class="flex justify-between items-center pt-3 border-t border-white/5">
                    <span class="text-xs font-mono ${wearColor}">Wears: ${f.wearCount}</span>
                    <button onclick="logWear('${f.id}')" class="bg-white/10 hover:bg-white/20 text-white text-xs font-bold px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">Log Wear <i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>`;
             return div;
        }

        function createComboCard(c, isTop) {
            const div = document.createElement('div');
            const bgClass = isTop ? 'bg-gradient-to-br from-purple-900/30 to-teal-900/30 border-teal-500/50' : 'combo-gradient border-teal-500/20';
            const partNames = c.parts.map(pid => { 
                const f = state.data.fragrances.find(x => x.id === pid); 
                return f ? f.name : pid; 
            }).join(' + ');
            
            div.className = `${bgClass} p-5 rounded-2xl border relative transition-all mb-3`;
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div><span class="text-[10px] font-bold tracking-widest text-teal-300 uppercase">LAYER COMBO</span><h3 class="text-xl font-bold text-white leading-tight">${c.name}</h3><p class="text-xs text-gray-300 mt-1">${partNames}</p></div>
                    <div class="flex flex-col items-end gap-1"><button onclick="openNote('${c.id}')" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sticky-note ${c.userNotes ? 'text-yellow-400 fill-current' : ''}"><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></svg></button></div>
                </div>
                <div class="bg-black/20 p-3 rounded-lg my-3 border border-white/5"><p class="text-sm text-gray-200 leading-relaxed">"${c.description}"</p><div class="mt-2 pt-2 border-t border-white/10 flex items-start gap-2"><i data-lucide="layers" class="w-4 h-4 text-teal-300 mt-1"></i><p class="text-xs text-teal-100 font-mono">${c.instructions}</p></div></div>
                <div class="flex justify-between items-center pt-3 border-t border-white/5"><span class="text-xs font-mono text-gray-400">Combo Wears: ${c.wearCount}</span><button onclick="logComboWear('${c.id}')" class="bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">Log Pair <i data-lucide="plus" class="w-4 h-4"></i></button></div>`;
            return div;
        }

        function logWear(id) {
             const idx = state.data.fragrances.findIndex(f => f.id === id);
             if (idx > -1) { 
                 state.data.fragrances[idx].wearCount++; 
                 state.data.history.push({ id, type:'single', date: new Date().toISOString(), context: { ...state.context }, feedbackRecorded: true });
                 saveData(); 
                 showToast('Wear Logged'); 
                 setTimeout(() => switchView('selector'), 500); 
            }
        }
        
        function logComboWear(id) {
             const comboIdx = state.data.combos.findIndex(c => c.id === id);
             if (comboIdx > -1) {
                 const combo = state.data.combos[comboIdx]; combo.wearCount++;
                 combo.parts.forEach(pid => { const fIdx = state.data.fragrances.findIndex(f => f.id === pid); if(fIdx > -1) state.data.fragrances[fIdx].wearCount++; });
                 state.data.history.push({ id, type:'combo', date: new Date().toISOString(), context: { ...state.context }, feedbackRecorded: false });
                 saveData(); 
                 showToast('Pair Logged'); 
                 setTimeout(() => switchView('history'), 500); 
            }
        }

        function logDecantWear(id) {
            let decant = state.data.decants.find(d => d.id === id);
            if (!decant && typeof id === 'number') decant = state.data.decants[id];
            if (!decant) return;
            state.data.history.push({ id: decant.id, type: 'decant', date: new Date().toISOString(), context: { ...state.context }, feedbackRecorded: false });
            saveData();
            showToast("Logged Decant");
            switchView('history');
        }

        function handleFeedback(logIndex, action) {
             const log = state.data.history[logIndex];
             log.feedbackRecorded = true;
             
             if (action === 'dislike') {
                 if (log.type === 'decant') {
                     if(confirm("Remove this decant from collection?")) {
                        state.data.decants = state.data.decants.filter(d => d.id !== log.id);
                        showToast("Decant Removed");
                     }
                 } else if (log.type === 'combo') {
                     showToast("Combo Disliked");
                 }
             } else if (action === 'like') {
                 if (log.type === 'decant') {
                     const d = state.data.decants.find(x => x.id === log.id);
                     if(d) d.rating = 'like';
                     showToast("Marked as Favorite");
                 } else {
                    showToast("Saved to Favorites");
                 }
             } else {
                 showToast("Will ask again");
             }
             saveData();
             renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list'); 
            list.innerHTML = '';
            
            const sortedHistory = [...state.data.history].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(sortedHistory.length === 0) { list.innerHTML = `<div class="text-center text-gray-500 mt-10">No wear history yet.</div>`; return; }

            sortedHistory.forEach((log, index) => {
                const realIndex = state.data.history.indexOf(log);
                
                let name = "Unknown"; let brand = ""; 
                
                if (log.type === 'single') { const f = state.data.fragrances.find(x => x.id === log.id); if(f) { name = f.name; brand = f.brand; } } 
                else if (log.type === 'combo') { const c = state.data.combos.find(x => x.id === log.id); if(c) { name = c.name; brand = "Combo"; } }
                else if (log.type === 'decant') { 
                    const d = state.data.decants.find(x => x.id === log.id); 
                    if(d) { name = d.name; brand = "Decant"; } 
                    else { name = "Deleted Decant"; } 
                }

                const dateObj = new Date(log.date); 
                const dateStr = dateObj.toLocaleDateString(); 
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let buttonsHtml = '';
                if (!log.feedbackRecorded && (log.type === 'combo' || log.type === 'decant')) {
                    buttonsHtml = `
                    <div class="mt-3 flex gap-2 pt-2 border-t border-white/5">
                        <button onclick="handleFeedback(${realIndex}, 'like')" class="flex-1 py-1.5 bg-green-500/20 text-green-300 rounded text-xs hover:bg-green-500/40 font-bold flex items-center justify-center gap-1"><i data-lucide="thumbs-up" class="w-3 h-3"></i> Like</button>
                        <button onclick="handleFeedback(${realIndex}, 'try_more')" class="flex-1 py-1.5 bg-blue-500/20 text-blue-300 rounded text-xs hover:bg-blue-500/40 font-bold flex items-center justify-center gap-1"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Retry</button>
                        <button onclick="handleFeedback(${realIndex}, 'dislike')" class="flex-1 py-1.5 bg-red-500/20 text-red-300 rounded text-xs hover:bg-red-500/40 font-bold flex items-center justify-center gap-1"><i data-lucide="thumbs-down" class="w-3 h-3"></i> Dislike</button>
                    </div>`;
                }

                const div = document.createElement('div'); 
                div.className = "glass-panel p-4 rounded-xl border border-white/5 mb-3";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2 mb-1"><span class="text-[10px] text-gray-400 font-mono">${dateStr} • ${timeStr}</span><span class="text-[9px] bg-white/10 px-1.5 py-0.5 rounded text-gray-300 uppercase">${log.context ? log.context.situation : 'Log'}</span></div>
                            <h4 class="font-bold text-white text-sm">${name}</h4>
                            <p class="text-[10px] text-teal-400 uppercase tracking-wider">${brand}</p>
                        </div>
                        <button onclick="openHistoryEdit(${realIndex})" class="bg-white/5 hover:bg-white/10 p-2 rounded-lg text-gray-400 hover:text-white transition-colors relative z-10"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    </div>
                    ${buttonsHtml}
                `;
                list.appendChild(div);
            });
            if (window.lucide) lucide.createIcons();
        }

        function setCollectionMode(mode) {
             state.ui.collectionMode = mode;
             document.getElementById('tab-bottles').className = mode === 'bottles' ? 'flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white/10 text-white' : 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-white';
             document.getElementById('tab-decants').className = mode === 'decants' ? 'flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white/10 text-white' : 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-white';
             document.getElementById('tab-combos').className = mode === 'combos' ? 'flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white/10 text-white' : 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-white';
             showCollection();
        }

        function showCollection() {
             const list = document.getElementById('collection-list');
             list.innerHTML = '';
             if(state.ui.collectionMode === 'bottles') {
                state.data.fragrances.forEach(f => {
                    const div = document.createElement('div');
                    div.className = `glass-panel p-4 rounded-xl border border-white/5 ${f.paused ? 'opacity-50' : ''}`;
                    
                    let tiersHtml = '';
                    TIERS.forEach(tier => {
                        const isActive = f.userRating === tier;
                        const activeClass = isActive ? 'tier-active' : `tier-${tier.toLowerCase()} border border-white/10 hover:bg-white/5`;
                        tiersHtml += `<button onclick="setRating('${f.id}', '${tier}')" class="w-6 h-6 text-[10px] rounded ${activeClass} tier-btn flex items-center justify-center">${tier}</button>`;
                    });
                    
                    const pairingClass = f.pairingOnly ? 'text-teal-400' : 'text-gray-600 hover:text-teal-300';
                    const pauseClass = f.paused ? 'text-yellow-400' : 'text-gray-600 hover:text-white';
                    const pauseIcon = f.paused ? 'play-circle' : 'pause-circle';

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div><span class="text-[10px] text-teal-400 font-bold uppercase tracking-wider">${f.brand}</span><h3 class="font-bold text-sm text-white">${f.name}</h3></div>
                            <div class="flex items-center gap-3">
                                 <button onclick="togglePairingOnly('${f.id}')" class="${pairingClass} transition-colors" title="Toggle Pairing Only"><i data-lucide="layers" class="w-4 h-4"></i></button>
                                 <button onclick="openNote('${f.id}')" class="text-gray-400"><i data-lucide="sticky-note" class="w-4 h-4 ${f.userNotes ? 'text-yellow-400 fill-current' : ''}"></i></button>
                                 <button onclick="togglePause('${f.id}')" class="${pauseClass} transition-colors"><i data-lucide="${pauseIcon}" class="w-4 h-4"></i></button>
                                 <button onclick="deleteFragrance('${f.id}')" class="text-gray-600 hover:text-red-500" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2"><div class="flex gap-1">${tiersHtml}</div></div>
                        <div class="flex justify-between items-center pt-2 border-t border-white/5">
                            <p class="text-[10px] text-gray-400 font-mono">Wears: ${f.wearCount}</p>
                            <button onclick="resetWear('${f.id}')" class="text-xs text-gray-500 hover:text-red-400 flex items-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
             } else if (state.ui.collectionMode === 'decants') {
                if(state.data.decants.length === 0) list.innerHTML = `<div class="text-center text-gray-500 p-4">No decants yet. Use Smart Add to add one.</div>`;
                state.data.decants.forEach((d, idx) => {
                    const div = document.createElement('div'); div.className = `glass-panel p-4 rounded-xl border border-white/5`;
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div><span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">${d.brand}</span><h3 class="font-bold text-sm text-white">${d.name}</h3></div>
                            <button onclick="deleteDecant(${idx})" class="text-gray-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <div class="mt-2">
                            <button onclick="logDecantWear('${d.id}')" class="w-full bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 rounded-lg flex items-center justify-center gap-2 transition-colors">Log Wear <i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else if (state.ui.collectionMode === 'combos') {
                if(state.data.combos.length === 0) list.innerHTML = `<div class="text-center text-gray-500 p-4">No combos found.</div>`;
                state.data.combos.forEach((c) => {
                    const div = document.createElement('div'); div.className = `combo-gradient p-4 rounded-xl border border-teal-500/20`;
                    const partNames = c.parts.map(pid => {
                        const f = state.data.fragrances.find(x => x.id === pid);
                        return f ? f.name : pid;
                    }).join(' + ');
                    
                    let tiersHtml = '';
                    TIERS.forEach(tier => {
                        const isActive = c.userRating === tier;
                        const activeClass = isActive ? 'tier-active' : `tier-${tier.toLowerCase()} border border-white/10 hover:bg-white/5`;
                        tiersHtml += `<button onclick="setRating('${c.id}', '${tier}')" class="w-6 h-6 text-[10px] rounded ${activeClass} tier-btn flex items-center justify-center">${tier}</button>`;
                    });
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                             <div>
                                <span class="text-[10px] text-teal-300 font-bold uppercase tracking-wider">COMBO RECIPE</span>
                                <h3 class="font-bold text-sm text-white">${c.name}</h3>
                                <p class="text-[10px] text-gray-300 mt-0.5">${partNames}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openNote('${c.id}')" class="text-gray-400"><i data-lucide="sticky-note" class="w-4 h-4 ${c.userNotes ? 'text-yellow-400 fill-current' : ''}"></i></button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2"><div class="flex gap-1">${tiersHtml}</div></div>
                        <div class="bg-black/30 p-2 rounded-lg mb-2">
                            <p class="text-[10px] text-teal-100 font-mono">${c.instructions}</p>
                        </div>
                        <div class="flex justify-between items-center pt-1 border-t border-white/5">
                             <p class="text-[10px] text-gray-400 font-mono">Wears: ${c.wearCount}</p>
                             <button onclick="logComboWear('${c.id}')" class="text-xs bg-teal-600 hover:bg-teal-500 text-white px-3 py-1 rounded font-bold">Log</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }
        
        function copyStats() {
            let report = "--- FRAGRANCE SOMMELIER STATS ---\n\n";
            report += "== BOTTLES ==\n";
            state.data.fragrances.sort((a,b) => b.wearCount - a.wearCount).forEach(f => {
                report += `${f.name} [${f.userRating || '-'}]: ${f.wearCount}\n`;
            });
            
            report += "\n== COMBOS ==\n";
            state.data.combos.sort((a,b) => b.wearCount - a.wearCount).forEach(c => {
                if(c.wearCount > 0) report += `${c.name} [${c.userRating || '-'}]: ${c.wearCount}\n`;
            });

            report += `\n== TOTAL LOGS: ${state.data.history.length} ==`;

            const area = document.getElementById('backup-area');
            area.value = report;
            area.select();
            document.execCommand('copy');
            showToast('Stats Copied');
        }

        function openSmartAdd() { document.getElementById('smart-add-modal').classList.remove('hidden'); }
        function closeSmartAdd() { document.getElementById('smart-add-modal').classList.add('hidden'); }
        function analyzeText() { alert("Paste text logic"); }
        function saveSmartAdd() { 
            if(!tempSmartObj) return alert("Please click 'Analyze' first."); 
            tempSmartObj.name = document.getElementById('sa-name').value || "New Fragrance"; 
            tempSmartObj.brand = document.getElementById('sa-brand').value || "Unknown House"; 
            const isDecant = document.getElementById('sa-is-decant').checked;
            if(isDecant) {
                state.data.decants.push({ id: tempSmartObj.id, name: tempSmartObj.name, brand: tempSmartObj.brand, tags: tempSmartObj.tags, description: tempSmartObj.description, rating: null });
                showToast('Decant Added');
            } else {
                state.data.fragrances.push(tempSmartObj); 
                showToast('Bottle Added');
            }
            saveData(); closeSmartAdd(); showCollection();
        }
        function togglePairingOnly(id) {
            const f = state.data.fragrances.find(i => i.id === id);
            if(f) {
                f.pairingOnly = !f.pairingOnly;
                saveData();
                showCollection();
                showToast(f.pairingOnly ? "Set to Pairing Only" : "Set to Solo + Pairing");
            }
        }
        function togglePause(id) {
            const f = state.data.fragrances.find(i => i.id === id);
            if (f) {
                f.paused = !f.paused;
                saveData();
                showCollection();
                showToast(f.paused ? "Fragrance Paused" : "Fragrance Resumed");
            }
        }
        function deleteFragrance(id) {
            if(confirm("Permanently delete this fragrance from your collection?")) {
                state.data.fragrances = state.data.fragrances.filter(f => f.id !== id);
                saveData();
                showCollection();
                showToast("Fragrance Deleted");
            }
        }
        function resetWear(id) { const idx = state.data.fragrances.findIndex(f => f.id === id); if (idx > -1) { state.data.fragrances[idx].wearCount = 0; saveData(); showCollection(); } }
        function deleteDecant(idx) {
            if(confirm('Remove this decant?')) {
                state.data.decants.splice(idx, 1);
                saveData();
                showCollection();
            }
        }
        function rateDecant() {}
        function setRating(id, tier) {
            let f = state.data.fragrances.find(i => i.id === id);
            if(f) {
                f.userRating = tier;
                saveData();
                showCollection(); 
                return;
            }
            let c = state.data.combos.find(i => i.id === id);
            if(c) {
                c.userRating = tier;
                saveData();
                showCollection();
            }
        }
        function openNote(id) { currentNoteId = id; let item = state.data.fragrances.find(f => f.id === id); if (!item) item = state.data.combos.find(c => c.id === id); document.getElementById('note-input').value = item.userNotes || ""; document.getElementById('notes-modal').classList.remove('hidden'); }
        function closeNotesModal() { document.getElementById('notes-modal').classList.add('hidden'); }
        function saveNote() {}
        
        function openAddLogModal() {
            const select = document.getElementById('add-log-fragrance');
            select.innerHTML = '';
            
            const fragGroup = document.createElement('optgroup');
            fragGroup.label = "Fragrances";
            state.data.fragrances.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.text = f.name;
                fragGroup.appendChild(opt);
            });
            select.appendChild(fragGroup);
            
            const comboGroup = document.createElement('optgroup');
            comboGroup.label = "Combos";
            state.data.combos.forEach(c => {
                 const opt = document.createElement('option');
                 opt.value = c.id;
                 opt.text = c.name + " (Combo)";
                 comboGroup.appendChild(opt);
            });
            select.appendChild(comboGroup);
            
             const now = new Date();
             const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
             document.getElementById('add-log-date').value = isoString;

            document.getElementById('add-log-modal').classList.remove('hidden');
        }
        
        function closeAddLogModal() { document.getElementById('add-log-modal').classList.add('hidden'); }
        
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function copyData() { 
            const area = document.getElementById('backup-area');
            area.value = JSON.stringify(state.data);
            area.select(); 
            document.execCommand('copy'); 
            alert('JSON Backup Copied!'); 
        }
        function resetView() { switchView('selector'); }

        // --- INIT LISTENER ---
        window.addEventListener('DOMContentLoaded', () => {
             loadData(); initUI(); 
             setTimeout(() => { if (window.lucide) lucide.createIcons(); }, 100);
             document.querySelectorAll('[id$="-modal"]').forEach(el => el.classList.add('hidden'));
        });
        
        // --- HISTORY EDIT (RE-ADDED & FIXED) ---
        function openHistoryEdit(index) {
             editingHistoryIndex = index;
             const log = state.data.history[index];
             const modal = document.getElementById('history-edit-modal');
             const dateInput = document.getElementById('hist-edit-date');
             const select = document.getElementById('hist-edit-fragrance');
             
             const d = new Date(log.date); 
             const isoString = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16); 
             dateInput.value = isoString;
             
             select.innerHTML = '';
             const optGroupFrag = document.createElement('optgroup'); optGroupFrag.label = "Fragrances";
             state.data.fragrances.forEach(f => { const opt = document.createElement('option'); opt.value = f.id; opt.text = f.name; if(f.id === log.id) opt.selected = true; optGroupFrag.appendChild(opt); });
             select.appendChild(optGroupFrag);
             const optGroupCombo = document.createElement('optgroup'); optGroupCombo.label = "Combos";
             state.data.combos.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.text = c.name + " (Combo)"; if(c.id === log.id) opt.selected = true; optGroupCombo.appendChild(opt); });
             select.appendChild(optGroupCombo);
             
             if (state.data.decants.length > 0) {
                const decantGroup = document.createElement('optgroup'); decantGroup.label = "Decants";
                state.data.decants.forEach(d => { const opt = document.createElement('option'); opt.value = d.id; opt.text = d.name + " (Decant)"; if(d.id === log.id) opt.selected = true; decantGroup.appendChild(opt); });
                select.appendChild(decantGroup);
             }

             modal.classList.remove('hidden');
        }
        function closeHistoryEdit() { document.getElementById('history-edit-modal').classList.add('hidden'); editingHistoryIndex = null; }
        
        function saveHistoryEdit() {
            if (editingHistoryIndex === null) return;
            const log = state.data.history[editingHistoryIndex]; 
            const newDate = document.getElementById('hist-edit-date').value; 
            const newId = document.getElementById('hist-edit-fragrance').value; 
            const oldId = log.id;
            
            log.date = new Date(newDate).toISOString();
            
            if (newId !== oldId) { 
                changeWearCount(oldId, -1); 
                changeWearCount(newId, 1); 
                
                log.id = newId; 
                
                const isCombo = state.data.combos.some(c => c.id === newId); 
                const isDecant = state.data.decants.some(d => d.id === newId);
                
                if (isCombo) log.type = 'combo';
                else if (isDecant) log.type = 'decant';
                else log.type = 'single';
            }
            
            saveData(); 
            closeHistoryEdit(); 
            renderHistory(); 
            showCollection(); 
            showToast('Log Updated');
        }
        
        function deleteHistoryEntry() { 
            if (editingHistoryIndex === null) return; 
            if(!confirm("Delete this log entry?")) return; 
            
            const log = state.data.history[editingHistoryIndex]; 
            changeWearCount(log.id, -1); 
            state.data.history.splice(editingHistoryIndex, 1); 
            
            saveData(); 
            closeHistoryEdit(); 
            renderHistory(); 
            showCollection(); 
            showToast('Entry Deleted'); 
        }
        
        function changeWearCount(id, delta) {
            const fIdx = state.data.fragrances.findIndex(f => f.id === id); 
            if (fIdx > -1) { 
                state.data.fragrances[fIdx].wearCount += delta; 
                if(state.data.fragrances[fIdx].wearCount < 0) state.data.fragrances[fIdx].wearCount = 0; 
                return; 
            }
            
            const cIdx = state.data.combos.findIndex(c => c.id === id); 
            if (cIdx > -1) { 
                const combo = state.data.combos[cIdx]; 
                combo.wearCount += delta; 
                if(combo.wearCount < 0) combo.wearCount = 0; 
                
                combo.parts.forEach(pid => { 
                    const partIdx = state.data.fragrances.findIndex(f => f.id === pid); 
                    if(partIdx > -1) { 
                        state.data.fragrances[partIdx].wearCount += delta; 
                        if(state.data.fragrances[partIdx].wearCount < 0) state.data.fragrances[partIdx].wearCount = 0; 
                    } 
                }); 
                return;
            }
        }

    </script>
</body>
</html>
