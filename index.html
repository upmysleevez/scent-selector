<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fragrance Sommelier</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827"> <!-- gray-900 -->
    <link rel="apple-touch-icon" href="https://lucide.dev/favicon.ico"> <!-- Placeholder icon -->

    <!-- External Libraries (CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#111827',
                            800: '#1F2937',
                            700: '#374151',
                        },
                        teal: {
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Safe Area & Scrollbar Hiding */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Smooth Fade In */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Active State for Touch */
        .touch-active:active {
            transform: scale(0.98);
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen w-screen flex flex-col overflow-hidden font-sans">

    <!-- Header -->
    <header class="flex-none px-6 py-5 flex justify-between items-center bg-gray-900 z-20 border-b border-gray-800">
        <div>
            <h1 class="text-xl font-bold tracking-tight text-white">Fragrance Sommelier</h1>
            <p class="text-xs text-gray-400 uppercase tracking-wider">Daily Ritual</p>
        </div>
        <button onclick="app.resetData()" class="p-2 text-gray-500 hover:text-white transition-colors">
            <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar p-4 relative pb-24">
        <!-- Views will be injected here via JS -->
    </main>

    <!-- Navigation Footer -->
    <nav class="flex-none bg-gray-900 border-t border-gray-800 pb-safe z-30">
        <div class="flex justify-around items-center h-16">
            <button onclick="app.navigate('select')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-teal-400 space-y-1" data-target="select">
                <i data-lucide="search" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Select</span>
            </button>
            <button onclick="app.navigate('collection')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 space-y-1" data-target="collection">
                <i data-lucide="library" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Collect</span>
            </button>
            <button onclick="app.navigate('history')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 space-y-1" data-target="history">
                <i data-lucide="clock" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">History</span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden flex items-end sm:items-center justify-center p-4">
        <!-- Modal Content Injected Here -->
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /**
         * FRAGRANCE SOMMELIER - CLIENT LOGIC
         * Version: 85 (Restored v83 Data)
         */

        const STORAGE_KEY = 'scentApp_v84_final';

        // --- 1. SEED DATA (HARD-CODED RESTORATION) ---
        
        const INITIAL_BOTTLES = [
            { id: "dossier_ambery_saffron", name: "Ambery Saffron", brand: "Dossier", tier: "B", wearCount: 0, situationRatings: { date_night: 5, intimate: 4, office: 1, gym: 1, casual: 2 }, weatherAffinity: { winter: 5, fall: 5, spring: 2, summer: 1 }, tags: ["saffron", "amber"] },
            { id: "lost_cherry", name: "Lost Cherry", brand: "Tom Ford", tier: "A", wearCount: 0, situationRatings: { date_night: 5, intimate: 5, office: 1, gym: 1, casual: 2 }, weatherAffinity: { winter: 5, fall: 5, spring: 2, summer: 1 }, tags: ["cherry", "almond"] },
            { id: "creed_aventus", name: "Aventus", brand: "Creed", tier: "B", wearCount: 2, situationRatings: { office: 5, casual: 5, gym: 3, date_night: 3, intimate: 2 }, weatherAffinity: { spring: 5, summer: 5, fall: 4, winter: 2 }, tags: ["pineapple", "birch"] },
            { id: "victory_man", name: "Victory Man", brand: "XXIV", tier: "C", wearCount: 0, situationRatings: { gym: 5, office: 4, casual: 3, date_night: 2, intimate: 1 }, weatherAffinity: { summer: 5, spring: 5, fall: 2, winter: 1 }, tags: ["fresh", "citrus"] },
            { id: "paco_1_million", name: "1 Million", brand: "Paco Rabanne", tier: "C", wearCount: 0, situationRatings: { date_night: 4, casual: 2, intimate: 3, office: 1, gym: 1 }, weatherAffinity: { winter: 5, fall: 5, spring: 2, summer: 1 }, tags: ["spicy", "sweet"] },
            { id: "blomb_27", name: "No. 27", brand: "BLOMB", tier: "B", wearCount: 1, situationRatings: { casual: 5, office: 3, date_night: 2, gym: 2, intimate: 2 }, weatherAffinity: { fall: 5, spring: 5, winter: 3, summer: 3 }, tags: ["floral", "musk"] },
            { id: "phantom_noir", name: "Phantom Noir", brand: "Montagne", tier: "A", wearCount: 0, situationRatings: { date_night: 5, intimate: 5, casual: 3, office: 2, gym: 1 }, weatherAffinity: { winter: 5, fall: 5, spring: 2, summer: 1 }, tags: ["chocolate", "dark"] },
            { id: "brooklyn_jazz", name: "Brooklyn Jazz", brand: "Montagne", tier: "A", wearCount: 0, situationRatings: { date_night: 5, intimate: 4, casual: 3, office: 2, gym: 1 }, weatherAffinity: { winter: 5, fall: 5, spring: 2, summer: 1 }, tags: ["boozy", "jazz"] },
            { id: "maison_du_soir", name: "Maison du Soir", brand: "Montagne", tier: "A", wearCount: 0, situationRatings: { intimate: 5, casual: 5, date_night: 4, office: 2, gym: 1 }, weatherAffinity: { winter: 5, fall: 5, spring: 3, summer: 1 }, tags: ["fireplace", "smoke"] },
            { id: "cubicle_men", name: "Cubicle for Men", brand: "Montagne", tier: "A", wearCount: 2, situationRatings: { office: 5, casual: 4, gym: 3, date_night: 2, intimate: 1 }, weatherAffinity: { summer: 5, spring: 5, fall: 3, winter: 1 }, tags: ["ambroxan", "clean"] },
            { id: "gentle_silver", name: "Gentle Silver", brand: "Montagne", tier: "S", wearCount: 5, situationRatings: { office: 5, gym: 4, casual: 4, date_night: 2, intimate: 1 }, weatherAffinity: { summer: 5, spring: 5, fall: 3, winter: 1 }, tags: ["juniper", "musk"] },
            { id: "vanille_absolute", name: "Vanille Absolute", brand: "Montagne", tier: "A", wearCount: 0, situationRatings: { date_night: 5, intimate: 4, casual: 3, office: 1, gym: 1 }, weatherAffinity: { winter: 5, fall: 5, spring: 2, summer: 1 }, tags: ["vanilla"] },
            { id: "eau_noir", name: "Eau Noir", brand: "Montagne", tier: "S", wearCount: 4, situationRatings: { date_night: 5, casual: 5, intimate: 4, office: 3, gym: 1 }, weatherAffinity: { fall: 5, winter: 5, spring: 3, summer: 1 }, tags: ["tea", "fig"] },
            { id: "prada_paradigme", name: "Paradigme", brand: "Prada", tier: "A", wearCount: 1, situationRatings: { office: 5, casual: 5, gym: 2, date_night: 3, intimate: 2 }, weatherAffinity: { spring: 5, summer: 5, fall: 3, winter: 1 }, tags: ["iris", "clean"] },
            { id: "fleurit_sainte_fumee", name: "Sainte Fumée", brand: "Fleurit", tier: "S", wearCount: 0, situationRatings: { intimate: 5, date_night: 5, casual: 3, office: 1, gym: 1 }, weatherAffinity: { winter: 5, fall: 5, spring: 2, summer: 1 }, tags: ["palo santo", "incense"] },
            { id: "hermes_terre_eau_intense", name: "Terre d'Hermès Eau Intense", brand: "Hermès", tier: "B", wearCount: 0, situationRatings: { office: 5, casual: 4, date_night: 3, gym: 1, intimate: 2 }, weatherAffinity: { spring: 5, fall: 5, summer: 3, winter: 2 }, tags: ["vetiver", "citrus"] }
        ];

        const INITIAL_DECANTS = [
            { id: "custom_1765648274151", name: "Labdanum 18", brand: "Le Labo", type: "decant", wearCount: 1, situationRatings: { intimate: 5, casual: 3, office: 2, date_night: 3, gym: 1 }, weatherAffinity: { winter: 4, fall: 4, spring: 3, summer: 2 }, tags: ["powdery", "animalic"] },
            { id: "custom_1765726222017", name: "Fil d’Or No1", brand: "Laurent Mazzone", type: "decant", wearCount: 1, situationRatings: { date_night: 5, intimate: 4, casual: 2, office: 1, gym: 0 }, weatherAffinity: { winter: 5, fall: 4, spring: 1, summer: 0 }, tags: ["boozy", "tobacco"] },
            { id: "black_orchid_decant", name: "Black Orchid", brand: "Tom Ford", type: "decant", wearCount: 0, situationRatings: { date_night: 5, intimate: 4, casual: 1, office: 0, gym: 0 }, weatherAffinity: { winter: 5, fall: 5, spring: 1, summer: 0 }, tags: ["dark", "chocolate", "suspense"] }
        ];

        const INITIAL_COMBOS = [
            { id: "combo_exec", name: "The Executive Suite", parts: ["creed_aventus", "dossier_ambery_saffron"], situationRatings: { date_night: 5, office: 3 }, weatherAffinity: { fall: 5, winter: 5 } },
            { id: "combo_cherry", name: "Cherry Lounge", parts: ["lost_cherry", "brooklyn_jazz"], situationRatings: { intimate: 5, date_night: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_gin_juice", name: "Gin & Juice", parts: ["gentle_silver", "creed_aventus"], situationRatings: { casual: 5, gym: 4 }, weatherAffinity: { summer: 5 } },
            { id: "combo_smoked_vanilla", name: "Smoked Vanilla", parts: ["maison_du_soir", "vanille_absolute"], situationRatings: { intimate: 5, date_night: 4 }, weatherAffinity: { winter: 5 } },
            { id: "combo_island_noir", name: "Island Noir", parts: ["creed_aventus", "blomb_27"], situationRatings: { date_night: 4, casual: 5 }, weatherAffinity: { summer: 5 } },
            { id: "combo_spiced_cherry", name: "Spiced Cherry", parts: ["lost_cherry", "vanille_absolute"], situationRatings: { date_night: 5, intimate: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_clean_cut", name: "The Clean Cut", parts: ["cubicle_men", "gentle_silver"], situationRatings: { office: 5, gym: 5 }, weatherAffinity: { summer: 5 } },
            { id: "combo_midnight_tea", name: "Midnight Tea", parts: ["eau_noir", "brooklyn_jazz"], situationRatings: { date_night: 5, intimate: 4 }, weatherAffinity: { fall: 5, winter: 5 } },
            { id: "combo_smoked_jazz", name: "Smoked Jazz", parts: ["fleurit_sainte_fumee", "brooklyn_jazz"], situationRatings: { intimate: 5, date_night: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_winter_hearth", name: "Winter Hearth", parts: ["fleurit_sainte_fumee", "maison_du_soir"], situationRatings: { intimate: 5, casual: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_holy_clean", name: "Holy Clean", parts: ["fleurit_sainte_fumee", "gentle_silver"], situationRatings: { casual: 5, office: 3 }, weatherAffinity: { fall: 5, spring: 5 } },
            { id: "combo_sacred_vanilla", name: "Sacred Vanilla", parts: ["fleurit_sainte_fumee", "vanille_absolute"], situationRatings: { intimate: 5, date_night: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_paradigm_shift", name: "Paradigm Shift", parts: ["prada_paradigme", "cubicle_men"], situationRatings: { office: 5, casual: 4 }, weatherAffinity: { spring: 5, summer: 5 } },
            { id: "combo_holy_saffron", name: "Holy Saffron", parts: ["fleurit_sainte_fumee", "dossier_ambery_saffron"], situationRatings: { date_night: 5, intimate: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_vanilla_smoke", name: "Vanilla Smoke", parts: ["maison_du_soir", "vanille_absolute"], situationRatings: { intimate: 5, casual: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_holy_gin", name: "Holy Gin", parts: ["gentle_silver", "fleurit_sainte_fumee"], situationRatings: { casual: 5, date_night: 3 }, weatherAffinity: { fall: 5, spring: 5 } },
            { id: "combo_vanilla_latte", name: "Vanilla Latte", parts: ["phantom_noir", "vanille_absolute"], situationRatings: { date_night: 5, intimate: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_london_fog", name: "London Fog", parts: ["eau_noir", "vanille_absolute"], situationRatings: { casual: 5, office: 4 }, weatherAffinity: { fall: 5, winter: 5 } },
            { id: "combo_office_power", name: "Office Power", parts: ["victory_man", "cubicle_men"], situationRatings: { office: 5, gym: 4 }, weatherAffinity: { summer: 5 } },
            { id: "combo_tropical_hearth", name: "Tropical Hearth", parts: ["creed_aventus", "maison_du_soir"], situationRatings: { date_night: 4, casual: 5 }, weatherAffinity: { fall: 5, winter: 5 } },
            { id: "combo_ceo", name: "The CEO", parts: ["hermes_terre_eau_intense", "cubicle_men"], situationRatings: { office: 5, casual: 3 }, weatherAffinity: { spring: 5, fall: 5 } },
            { id: "combo_gin_earth", name: "Gin & Earth", parts: ["hermes_terre_eau_intense", "gentle_silver"], situationRatings: { casual: 5, office: 3 }, weatherAffinity: { spring: 5, summer: 5 } },
            { id: "combo_earth_king", name: "The Earth King", parts: ["hermes_terre_eau_intense", "creed_aventus"], situationRatings: { casual: 5, office: 5 }, weatherAffinity: { spring: 5, fall: 5 } },
            { id: "combo_midnight_cacao", name: "Midnight Cacao", parts: ["phantom_noir", "fleurit_sainte_fumee"], situationRatings: { date_night: 5, intimate: 5 }, weatherAffinity: { winter: 5 } },
            { id: "combo_iron_man", name: "Iron Man", parts: ["prada_paradigme", "victory_man"], situationRatings: { gym: 5, office: 4 }, weatherAffinity: { summer: 5, spring: 5 } },
            { id: "combo_dark_architect", name: "The Dark Architect", parts: ["black_orchid_decant", "hermes_terre_eau_intense"], situationRatings: { date_night: 5, intimate: 4 }, weatherAffinity: { winter: 5, fall: 5 } }
        ];

        const INITIAL_HISTORY = [
            { date: "2025-11-29", time: "13:35", scentId: "cubicle_men", type: "single", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-11-30", time: "13:45", scentId: "gentle_silver", type: "single", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-01", time: "12:39", scentId: "combo_clean_cut", type: "combo", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-03", time: "20:21", scentId: "eau_noir", type: "single", season: "Winter", weather: "Sunny", situation: "Casual" },
            { date: "2025-12-04", time: "12:48", scentId: "eau_noir", type: "single", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-05", time: "12:44", scentId: "eau_noir", type: "single", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-06", time: "13:29", scentId: "combo_gin_juice", type: "combo", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-07", time: "13:30", scentId: "blomb_27", type: "single", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-08", time: "12:41", scentId: "gentle_silver", type: "single", season: "Winter", weather: "Rainy", situation: "Office" },
            { date: "2025-12-10", time: "16:55", scentId: "gentle_silver", type: "single", season: "Winter", weather: "Sunny", situation: "Casual" },
            { date: "2025-12-11", time: "12:40", scentId: "prada_paradigme", type: "single", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-12", time: "12:43", scentId: "eau_noir", type: "single", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-13", time: "13:15", scentId: "custom_1765648274151", type: "decant", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-14", time: "13:20", scentId: "custom_1765726222017", type: "decant", season: "Fall", weather: "Sunny", situation: "Office" },
            { date: "2025-12-15", time: "14:22", scentId: "creed_aventus", type: "single", season: "Winter", weather: "Sunny", situation: "Office" }
        ];

        // --- 2. APP LOGIC & STATE ---

        const app = {
            data: {
                bottles: [],
                decants: [],
                combos: [],
                history: []
            },
            context: {
                season: 'Winter',
                weather: 'Sunny',
                situation: 'Office',
                suspense: false
            },
            
            init() {
                this.loadData();
                this.navigate('select');
                lucide.createIcons();
            },

            loadData() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    this.data = JSON.parse(stored);
                } else {
                    // Load Defaults (Data Restoration)
                    this.data.bottles = JSON.parse(JSON.stringify(INITIAL_BOTTLES));
                    this.data.decants = JSON.parse(JSON.stringify(INITIAL_DECANTS));
                    this.data.combos = JSON.parse(JSON.stringify(INITIAL_COMBOS));
                    this.data.history = JSON.parse(JSON.stringify(INITIAL_HISTORY));
                    this.saveData();
                }
            },

            saveData() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
            },

            resetData() {
                if(confirm("Reset entire database to factory settings? This cannot be undone.")) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            },

            // --- 3. DEEP ROTATION ALGORITHM v82 ---
            calculateScore(item, context) {
                let score = 0;
                
                // 1. Situation Context (High Weight: x4)
                const sitKey = context.situation.toLowerCase().replace(' ', '_');
                const sitRating = item.situationRatings?.[sitKey] || 1; // Default to 1 (neutral) if missing
                if (sitRating === 0) return -100; // Disqualify "Avoid" items
                score += sitRating * 4;

                // 2. Weather Context (Medium Weight: x2)
                const seasonKey = context.season.toLowerCase();
                // Simple check for season affinity first
                let affRating = item.weatherAffinity?.[seasonKey] || 1;
                score += affRating * 2;

                // 3. Tier Bonus (Bottles Only)
                if (item.tier) {
                    if (item.tier === 'S') score += 20;
                    if (item.tier === 'A') score += 12;
                    if (item.tier === 'B') score += 5;
                } else {
                    // Combo Base Bonus to compete with bottles
                    score += 8;
                }

                // 4. Freshness / Staleness (Rotation Logic)
                if (item.wearCount === 0) {
                    score += 5; // Discovery Bonus
                } else {
                    score -= (item.wearCount * 2); // Penalty for over-wear
                }

                // 5. Suspense Mode
                if (context.suspense && item.tags && item.tags.includes('suspense')) {
                    score += 10;
                }

                // 6. Random Jitter (Break Ties)
                score += Math.random() * 4;

                return score;
            },

            getRecommendations() {
                // Combine all eligible items
                let allItems = [
                    ...this.data.bottles.map(b => ({...b, type: 'bottle'})),
                    ...this.data.decants.map(d => ({...d, type: 'decant'})),
                    ...this.data.combos.map(c => ({...c, type: 'combo'}))
                ];

                // Calculate Scores
                allItems = allItems.map(item => {
                    item.score = this.calculateScore(item, this.context);
                    return item;
                });

                // Sort descending
                allItems.sort((a, b) => b.score - a.score);

                // Filter out disqualified
                return allItems.filter(i => i.score > -50);
            },

            logWear(id, type) {
                // Find item
                let collection = type === 'combo' ? this.data.combos : (type === 'decant' ? this.data.decants : this.data.bottles);
                let item = collection.find(i => i.id === id);
                
                if (item) {
                    // 1. Update Inventory Stats
                    if (item.wearCount !== undefined) item.wearCount++;
                    
                    // 2. Add to History
                    const now = new Date();
                    const entry = {
                        date: now.toISOString().split('T')[0],
                        time: now.toTimeString().split(' ')[0].substring(0, 5),
                        scentId: id,
                        type: type,
                        season: this.context.season,
                        weather: this.context.weather,
                        situation: this.context.situation
                    };
                    this.data.history.unshift(entry); // Add to top
                    
                    this.saveData();
                    alert(`Logged wear for ${item.name}!`);
                    this.navigate('history');
                }
            },

            // --- 4. NAVIGATION & VIEW RENDERING ---

            navigate(viewId) {
                // Update active tab state
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const icon = btn.querySelector('i');
                    const text = btn.querySelector('span');
                    if (btn.dataset.target === viewId) {
                        btn.classList.remove('text-gray-500');
                        btn.classList.add('text-teal-400');
                    } else {
                        btn.classList.add('text-gray-500');
                        btn.classList.remove('text-teal-400');
                    }
                });

                const main = document.getElementById('main-content');
                main.innerHTML = ''; // Clear current view
                
                // Inject new view
                if (viewId === 'select') this.renderSelect(main);
                if (viewId === 'results') this.renderResults(main);
                if (viewId === 'collection') this.renderCollection(main);
                if (viewId === 'history') this.renderHistory(main);

                lucide.createIcons();
            },

            renderSelect(container) {
                container.innerHTML = `
                    <div class="fade-in space-y-6">
                        <!-- Situation -->
                        <section>
                            <h2 class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider">Situation</h2>
                            <div class="grid grid-cols-2 gap-3">
                                ${['Office', 'Gym', 'Date Night', 'Casual', 'Intimate'].map(sit => `
                                    <button onclick="app.setContext('situation', '${sit}', this)" 
                                        class="ctx-btn p-4 rounded-xl border border-gray-700 bg-gray-800 text-left hover:bg-gray-700 transition-all ${this.context.situation === sit ? 'ring-2 ring-teal-500 bg-gray-700' : ''}">
                                        <span class="font-medium">${sit}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </section>

                        <!-- Weather -->
                        <section>
                            <h2 class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider">Weather</h2>
                            <div class="grid grid-cols-2 gap-3">
                                ${['Sunny', 'Rainy'].map(w => `
                                    <button onclick="app.setContext('weather', '${w}', this)" 
                                        class="ctx-btn p-4 rounded-xl border border-gray-700 bg-gray-800 text-left hover:bg-gray-700 transition-all ${this.context.weather === w ? 'ring-2 ring-teal-500 bg-gray-700' : ''}">
                                        <span class="font-medium">${w}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </section>

                        <!-- Season -->
                        <section>
                            <h2 class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider">Season</h2>
                            <div class="grid grid-cols-4 gap-2">
                                ${['Winter', 'Spring', 'Summer', 'Fall'].map(s => `
                                    <button onclick="app.setContext('season', '${s}', this)" 
                                        class="ctx-btn p-3 rounded-xl border border-gray-700 bg-gray-800 text-center hover:bg-gray-700 transition-all ${this.context.season === s ? 'ring-2 ring-teal-500 bg-gray-700' : ''}">
                                        <span class="text-xs font-bold">${s}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </section>

                        <!-- Suspense Toggle -->
                        <div id="suspense-wrapper" class="hidden flex items-center justify-between p-4 bg-gray-800 rounded-xl border border-gray-700">
                            <span class="font-medium text-purple-300">Suspense Mode</span>
                            <button onclick="app.toggleSuspense()" class="w-12 h-6 rounded-full transition-colors ${this.context.suspense ? 'bg-purple-600' : 'bg-gray-600'} relative">
                                <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform ${this.context.suspense ? 'left-7' : 'left-1'}"></div>
                            </button>
                        </div>

                        <!-- Action -->
                        <button onclick="app.navigate('results')" class="w-full py-5 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-2xl shadow-lg shadow-teal-900/50 touch-active transition-all mt-4 flex items-center justify-center space-x-2">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                            <span>Find My Scent</span>
                        </button>
                    </div>
                `;
                this.updateSuspenseVisibility();
            },

            setContext(key, value, btn) {
                this.context[key] = value;
                // Re-render only to update styling is a bit heavy, strictly modifying classes is better but full re-render is safe for this size
                this.renderSelect(document.getElementById('main-content'));
                lucide.createIcons();
            },

            toggleSuspense() {
                this.context.suspense = !this.context.suspense;
                this.renderSelect(document.getElementById('main-content'));
                lucide.createIcons();
            },

            updateSuspenseVisibility() {
                const wrapper = document.getElementById('suspense-wrapper');
                if (this.context.situation === 'Date Night' || this.context.situation === 'Intimate') {
                    wrapper.classList.remove('hidden');
                }
            },

            renderResults(container) {
                const results = this.getRecommendations();
                const top3 = results.slice(0, 3);
                const rotation = results.slice(3, 8);

                let html = `
                    <div class="fade-in pb-10">
                        <div class="flex justify-between items-end mb-4">
                            <h2 class="text-2xl font-bold text-white">Top Picks</h2>
                            <span class="text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded border border-gray-700">${this.context.season} • ${this.context.situation}</span>
                        </div>
                `;

                // Top 3 Cards
                const labels = ["Signature Choice", "The Alternative", "Wildcard"];
                const colors = ["border-teal-500", "border-purple-500", "border-orange-500"];
                const textColors = ["text-teal-400", "text-purple-400", "text-orange-400"];

                top3.forEach((item, index) => {
                    html += `
                        <div class="bg-gray-800 rounded-2xl p-5 mb-4 border-l-4 ${colors[index]} shadow-lg relative">
                            <div class="absolute top-4 right-4 bg-gray-900 px-2 py-1 rounded text-xs font-mono text-gray-500">Score: ${Math.round(item.score)}</div>
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-1 ${textColors[index]}">${labels[index]}</h3>
                            <h2 class="text-xl font-bold text-white mb-1">${item.name}</h2>
                            <p class="text-sm text-gray-400 mb-4">${item.brand || "Custom Combo"}</p>
                            
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${item.tags ? item.tags.slice(0, 3).map(t => `<span class="text-xs bg-gray-900 text-gray-300 px-2 py-1 rounded-full border border-gray-700">#${t}</span>`).join('') : ''}
                            </div>

                            <button onclick="app.logWear('${item.id}', '${item.type}')" class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-xl text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i> Log Wear
                            </button>
                        </div>
                    `;
                });

                // Rotation List
                html += `<h3 class="text-lg font-bold text-gray-300 mt-8 mb-4">Rotation Options</h3>`;
                html += `<div class="space-y-3">`;
                
                rotation.forEach(item => {
                    html += `
                        <div class="bg-gray-800/50 p-4 rounded-xl flex justify-between items-center border border-gray-800">
                            <div>
                                <div class="font-medium text-white">${item.name}</div>
                                <div class="text-xs text-gray-500">${item.brand || "Combo"}</div>
                            </div>
                            <button onclick="app.logWear('${item.id}', '${item.type}')" class="p-2 bg-gray-700 rounded-full hover:bg-teal-600 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4 text-white"></i>
                            </button>
                        </div>
                    `;
                });
                html += `</div></div>`;
                container.innerHTML = html;
            },

            renderCollection(container) {
                // Determine active tab (default bottles)
                if (!this.activeCollectionTab) this.activeCollectionTab = 'bottles';

                let content = '';
                let list = [];
                
                if (this.activeCollectionTab === 'bottles') list = this.data.bottles;
                if (this.activeCollectionTab === 'decants') list = this.data.decants;
                if (this.activeCollectionTab === 'combos') list = this.data.combos;

                content = `
                    <div class="fade-in">
                        <!-- Tabs -->
                        <div class="flex p-1 bg-gray-800 rounded-lg mb-6">
                            ${['bottles', 'decants', 'combos'].map(tab => `
                                <button onclick="app.switchCollectionTab('${tab}')" 
                                    class="flex-1 py-2 text-xs font-medium rounded-md transition-all ${this.activeCollectionTab === tab ? 'bg-gray-600 text-white shadow' : 'text-gray-400'}">
                                    ${tab.charAt(0).toUpperCase() + tab.slice(1)}
                                </button>
                            `).join('')}
                        </div>

                        <!-- Header Action -->
                        ${this.activeCollectionTab === 'combos' ? `
                            <button onclick="app.openCreateModal()" class="w-full mb-4 py-3 border border-dashed border-gray-600 text-gray-400 rounded-xl flex items-center justify-center gap-2 hover:bg-gray-800 transition-colors">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Create Custom Combo
                            </button>
                        ` : ''}

                        <!-- List -->
                        <div class="space-y-4 pb-20">
                            ${list.map(item => `
                                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 relative">
                                    ${item.tier ? `<span class="absolute top-4 right-4 text-xs font-bold ${item.tier === 'S' ? 'text-yellow-400' : (item.tier === 'A' ? 'text-teal-400' : 'text-gray-500')}">Tier ${item.tier}</span>` : ''}
                                    <h3 class="font-bold text-white">${item.name}</h3>
                                    <p class="text-sm text-gray-400">${item.brand || (item.parts ? item.parts.join(' + ') : '')}</p>
                                    
                                    ${item.parts ? `
                                        <div class="mt-2 text-xs text-gray-500 bg-gray-900 p-2 rounded inline-block">
                                            Recipe: ${this.getRecipeNames(item.parts)}
                                        </div>
                                    ` : ''}

                                    <div class="mt-3 flex gap-2">
                                        <span class="text-xs bg-gray-900 px-2 py-1 rounded text-gray-500">Wears: ${item.wearCount || 0}</span>
                                        ${item.tags ? item.tags.slice(0,2).map(t=>`<span class="text-xs bg-gray-900 px-2 py-1 rounded text-gray-500">#${t}</span>`).join('') : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML = content;
            },

            switchCollectionTab(tab) {
                this.activeCollectionTab = tab;
                this.renderCollection(document.getElementById('main-content'));
                lucide.createIcons();
            },

            getRecipeNames(parts) {
                // Helper to resolve IDs to Names
                return parts.map(id => {
                    const b = this.data.bottles.find(x => x.id === id);
                    const d = this.data.decants.find(x => x.id === id);
                    return b ? b.name : (d ? d.name : id);
                }).join(' + ');
            },

            renderHistory(container) {
                let html = `<div class="fade-in space-y-4 pb-10">`;
                
                this.data.history.forEach(entry => {
                    // Find name
                    let name = "Unknown Scent";
                    let b = this.data.bottles.find(i => i.id === entry.scentId);
                    let d = this.data.decants.find(i => i.id === entry.scentId);
                    let c = this.data.combos.find(i => i.id === entry.scentId);
                    if (b) name = b.name;
                    if (d) name = d.name;
                    if (c) name = c.name;

                    html += `
                        <div class="flex items-start gap-4 border-b border-gray-800 pb-4">
                            <div class="flex flex-col items-center">
                                <span class="text-xs font-bold text-gray-500 w-12 text-center">${entry.date.slice(5)}</span>
                                <span class="text-[10px] text-gray-600">${entry.time}</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-white text-sm">${name}</h4>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-[10px] bg-gray-800 text-teal-400 px-1.5 py-0.5 rounded border border-gray-700">${entry.situation}</span>
                                    <span class="text-[10px] bg-gray-800 text-gray-400 px-1.5 py-0.5 rounded border border-gray-700">${entry.weather}</span>
                                </div>
                            </div>
                            <div class="text-gray-600">
                                <i data-lucide="${entry.type === 'combo' ? 'layers' : 'spray-can'}" class="w-4 h-4"></i>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                container.innerHTML = html;
            },

            // --- 5. CUSTOM CREATION LOGIC ---
            
            openCreateModal() {
                const modal = document.getElementById('modal-overlay');
                const allScents = [...this.data.bottles, ...this.data.decants];
                
                modal.innerHTML = `
                    <div class="bg-gray-900 w-full max-w-md rounded-t-2xl sm:rounded-2xl border border-gray-700 p-6 shadow-2xl animate-slide-up">
                        <h3 class="text-xl font-bold text-white mb-4">Create New Combo</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="combo-name" placeholder="Combo Name (e.g. Midnight Storm)" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-teal-500 outline-none">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-500 mb-1 block">Scent 1</label>
                                    <select id="scent-1" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm text-white">
                                        ${allScents.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 mb-1 block">Scent 2</label>
                                    <select id="scent-2" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm text-white">
                                        ${allScents.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <button onclick="app.saveCustomCombo()" class="w-full py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-xl mt-4">Save & Add to Collection</button>
                            <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="w-full py-3 text-gray-500 hover:text-white text-sm">Cancel</button>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');
            },

            saveCustomCombo() {
                const name = document.getElementById('combo-name').value;
                const id1 = document.getElementById('scent-1').value;
                const id2 = document.getElementById('scent-2').value;

                if (!name) return alert("Please name your combo.");

                const item1 = [...this.data.bottles, ...this.data.decants].find(i => i.id === id1);
                const item2 = [...this.data.bottles, ...this.data.decants].find(i => i.id === id2);

                // Average the ratings
                const newSituations = {};
                ['office', 'gym', 'casual', 'date_night', 'intimate'].forEach(k => {
                    const r1 = item1.situationRatings?.[k] || 1;
                    const r2 = item2.situationRatings?.[k] || 1;
                    newSituations[k] = Math.round((r1 + r2) / 2);
                });

                const newWeather = {};
                ['winter', 'spring', 'summer', 'fall'].forEach(k => {
                    const r1 = item1.weatherAffinity?.[k] || 1;
                    const r2 = item2.weatherAffinity?.[k] || 1;
                    newWeather[k] = Math.round((r1 + r2) / 2);
                });

                const newCombo = {
                    id: 'custom_' + Date.now(),
                    name: name,
                    parts: [id1, id2],
                    wearCount: 0,
                    situationRatings: newSituations,
                    weatherAffinity: newWeather,
                    tags: ["custom"]
                };

                this.data.combos.push(newCombo);
                this.saveData();
                document.getElementById('modal-overlay').classList.add('hidden');
                this.switchCollectionTab('combos');
            }
        };

        // Initialize App
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
